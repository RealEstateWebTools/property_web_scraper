<div class="container pws-property-page">

  <!-- Breadcrumb -->
  <nav class="pws-breadcrumb">
    <a href="/"><i class="bi bi-house me-1"></i>Home</a>
    <i class="bi bi-chevron-right"></i>
    <span>Property Details</span>
  </nav>

  <div class="row">
    <!-- Left column: images + description -->
    <div class="col-lg-8">

      <!-- Main image / carousel -->
      <% if @listing.image_urls.present? && @listing.image_urls.length > 1 %>
        <div class="pws-gallery-card" data-controller="carousel">
          <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-indicators">
              <% @listing.image_urls.each_with_index do |_url, index| %>
                <button type="button" data-bs-target="#propertyCarousel" data-bs-slide-to="<%= index %>"
                  <% if index == 0 %>class="active" aria-current="true"<% end %>
                  aria-label="Slide <%= index + 1 %>"></button>
              <% end %>
            </div>
            <div class="carousel-inner">
              <% @listing.image_urls.each_with_index do |image_url, index| %>
                <div class="carousel-item<%= ' active' if index == 0 %>">
                  <img src="<%= image_url %>" class="d-block w-100 pws-gallery-img" alt="Property image <%= index + 1 %>">
                </div>
              <% end %>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
          <div class="pws-gallery-count">
            <i class="bi bi-images"></i> <%= @listing.image_urls.length %> photos
          </div>
        </div>
      <% elsif @main_image_url.present? %>
        <div class="pws-gallery-card">
          <img src="<%= @main_image_url %>" class="w-100 pws-gallery-img" alt="Property image">
        </div>
      <% end %>

      <!-- Description -->
      <% if @listing.description.present? %>
        <div class="pws-section-card">
          <h5><i class="bi bi-text-paragraph me-2"></i>Description</h5>
          <div class="pws-description-text">
            <%= sanitize_html(@listing.description) %>
          </div>
        </div>
      <% end %>

      <!-- Map -->
      <% if @markers.present? && @markers.length > 0 %>
        <div class="pws-section-card">
          <h5><i class="bi bi-geo-alt me-2"></i>Location</h5>
          <div data-controller="google-map"
               data-google-map-markers-value="<%= @markers.to_json %>"
               data-google-map-zoom-value="15"
               data-google-map-api-key-value="<%= ENV['GOOGLE_MAPS_API_KEY'] %>">
            <div data-google-map-target="container" class="pws-map"></div>
          </div>
        </div>
      <% end %>

    </div>

    <!-- Right column: key info sidebar -->
    <div class="col-lg-4">

      <!-- Title & type badge -->
      <div class="pws-info-sidebar">
        <div class="pws-property-badges mb-3">
          <% if @listing.for_sale %>
            <span class="badge bg-success"><i class="bi bi-house-door me-1"></i>For Sale</span>
          <% end %>
          <% if @listing.for_rent %>
            <span class="badge bg-info text-dark"><i class="bi bi-key me-1"></i>For Rent</span>
          <% end %>
        </div>

        <% if @listing.title.present? %>
          <h4 class="pws-property-title"><%= @listing.title %></h4>
        <% end %>

        <% if @listing.address_string.present? %>
          <p class="text-muted mb-3">
            <i class="bi bi-geo-alt me-1"></i><%= @listing.address_string %>
          </p>
        <% end %>

        <!-- Price -->
        <% if @listing.price_string.present? %>
          <div class="pws-price-block">
            <span class="pws-price"><%= @listing.price_string %></span>
            <% if @listing.currency.present? %>
              <span class="pws-currency"><%= @listing.currency %></span>
            <% end %>
          </div>
        <% end %>

        <!-- Key stats -->
        <div class="pws-key-stats">
          <% if @listing.count_bedrooms.present? && @listing.count_bedrooms.to_i > 0 %>
            <div class="pws-key-stat">
              <i class="bi bi-door-open"></i>
              <span class="pws-key-stat-value"><%= @listing.count_bedrooms %></span>
              <span class="pws-key-stat-label">Bedrooms</span>
            </div>
          <% end %>
          <% if @listing.count_bathrooms.present? && @listing.count_bathrooms.to_i > 0 %>
            <div class="pws-key-stat">
              <i class="bi bi-droplet"></i>
              <span class="pws-key-stat-value"><%= @listing.count_bathrooms %></span>
              <span class="pws-key-stat-label">Bathrooms</span>
            </div>
          <% end %>
          <% if @listing.constructed_area.present? && @listing.constructed_area.to_i > 0 %>
            <div class="pws-key-stat">
              <i class="bi bi-arrows-angle-expand"></i>
              <span class="pws-key-stat-value"><%= @listing.constructed_area %></span>
              <span class="pws-key-stat-label"><%= @listing.area_unit.presence || 'm&sup2;' %></span>
            </div>
          <% end %>
        </div>

        <!-- All details -->
        <%= render partial: '/property_web_scraper/single_property_view/property_info_list' %>

        <!-- Actions -->
        <div class="pws-property-actions">
          <% if @listing.import_url.present? %>
            <%= link_to @listing.import_url, target: "_blank", class: "btn btn-outline-primary btn-sm w-100 mb-2" do %>
              <i class="bi bi-box-arrow-up-right me-1"></i> View Original Listing
            <% end %>
          <% end %>
          <% if @listing.import_url.present? %>
            <%= link_to retriever_as_json_path(url: @listing.import_url), class: "btn btn-outline-secondary btn-sm w-100 mb-2" do %>
              <i class="bi bi-braces me-1"></i> Get JSON
            <% end %>
          <% end %>
        </div>

        <!-- Share -->
        <div class="pws-share-row">
          <span class="text-muted me-2"><small>Share:</small></span>
          <% share_url = request.original_url %>
          <% share_title = @listing.title || "Property Listing" %>
          <a href="https://www.facebook.com/sharer/sharer.php?u=<%= ERB::Util.url_encode(share_url) %>" target="_blank" title="Share on Facebook" class="pws-share-link">
            <i class="bi bi-facebook"></i>
          </a>
          <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= ERB::Util.url_encode(share_url) %>" target="_blank" title="Share on LinkedIn" class="pws-share-link">
            <i class="bi bi-linkedin"></i>
          </a>
          <a href="https://twitter.com/intent/tweet?url=<%= ERB::Util.url_encode(share_url) %>&text=<%= ERB::Util.url_encode(share_title) %>" target="_blank" title="Share on Twitter" class="pws-share-link">
            <i class="bi bi-twitter-x"></i>
          </a>
        </div>
      </div>

    </div>
  </div>
</div>
