---
import BaseLayout from '../../layouts/BaseLayout.astro';
const fbApiKey = import.meta.env.PUBLIC_FIREBASE_API_KEY ?? '';
const fbAuthDomain = import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN ?? '';
---
<BaseLayout title="Account Action — Property Web Scraper">

<div id="fb-config" data-api-key={fbApiKey} data-auth-domain={fbAuthDomain} class="hidden"></div>

<section class="max-w-lg mx-auto px-4 py-12">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

    <div class="bg-gradient-to-br from-blue-600 to-blue-700 px-8 py-8 text-white">
      <h1 id="page-title" class="text-2xl font-bold mb-1">Processing…</h1>
      <p id="page-subtitle" class="text-blue-100 text-sm">Please wait.</p>
    </div>

    <!-- Loading state -->
    <div id="loading-section" class="px-8 py-8 text-center">
      <p class="text-sm text-gray-500">Processing your request…</p>
    </div>

    <!-- Success state -->
    <div id="success-section" class="hidden px-8 py-8">
      <div class="flex items-center gap-2 text-green-700 mb-4">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        <span id="success-msg" class="font-semibold text-base"></span>
      </div>
      <a id="success-link" href="/account"
        class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors no-underline">
        Continue
      </a>
    </div>

    <!-- Reset password form -->
    <div id="reset-section" class="hidden px-8 py-8">
      <div class="mb-5">
        <label for="new-password" class="block text-sm font-semibold text-gray-700 mb-2">New password</label>
        <input
          id="new-password"
          type="password"
          placeholder="At least 8 characters"
          autocomplete="new-password"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>
      <div class="mb-6">
        <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">Confirm password</label>
        <input
          id="confirm-password"
          type="password"
          placeholder="Repeat password"
          autocomplete="new-password"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>
      <p id="reset-error" class="text-red-600 text-xs mb-4 hidden"></p>
      <button id="reset-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors cursor-pointer border-0">
        Set New Password
      </button>
    </div>

    <!-- Error state -->
    <div id="error-section" class="hidden px-8 py-8">
      <p class="text-red-600 text-sm mb-4" id="error-msg">Something went wrong.</p>
      <a href="/login" class="block w-full text-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl text-sm transition-colors no-underline">
        Back to Sign In
      </a>
    </div>

  </div>
</section>

<script is:inline>
(function () {
  var cfg = document.getElementById('fb-config');
  var apiKey = cfg && cfg.dataset.apiKey;
  var authDomain = cfg && cfg.dataset.authDomain;

  var params = new URLSearchParams(window.location.search);
  var mode = params.get('mode');
  var oobCode = params.get('oobCode');
  var continueUrl = params.get('continueUrl') || '/account';

  // Sanitise continueUrl: only allow same-origin or relative paths
  try {
    var parsed = new URL(continueUrl);
    if (parsed.origin !== window.location.origin) {
      continueUrl = '/account';
    }
  } catch (_) {
    // relative path — keep as-is
  }

  var pageTitle = document.getElementById('page-title');
  var pageSubtitle = document.getElementById('page-subtitle');
  var loadingSection = document.getElementById('loading-section');
  var successSection = document.getElementById('success-section');
  var successMsg = document.getElementById('success-msg');
  var successLink = document.getElementById('success-link');
  var resetSection = document.getElementById('reset-section');
  var resetBtn = document.getElementById('reset-btn');
  var resetError = document.getElementById('reset-error');
  var errorSection = document.getElementById('error-section');
  var errorMsg = document.getElementById('error-msg');

  function showError(msg) {
    loadingSection.classList.add('hidden');
    resetSection.classList.add('hidden');
    errorSection.classList.remove('hidden');
    errorMsg.textContent = msg || 'An error occurred. Please try again.';
  }

  function showSuccess(msg, href) {
    loadingSection.classList.add('hidden');
    resetSection.classList.add('hidden');
    successSection.classList.remove('hidden');
    successMsg.textContent = msg;
    successLink.href = href || '/account';
  }

  if (!oobCode || !mode) {
    showError('Invalid or missing action code. Please use the link from your email.');
    return;
  }

  async function run() {
    var baseUrl = 'https://www.gstatic.com/firebasejs/11.3.1/';
    var app = await import(baseUrl + 'firebase-app.js');
    var auth = await import(baseUrl + 'firebase-auth.js');

    var firebaseApp = app.initializeApp({ apiKey: apiKey, authDomain: authDomain });
    var firebaseAuth = auth.getAuth(firebaseApp);

    if (mode === 'verifyEmail') {
      pageTitle.textContent = 'Verifying email…';
      pageSubtitle.textContent = 'Confirming your email address.';

      await auth.applyActionCode(firebaseAuth, oobCode);

      // Reload current user if signed in so emailVerified is fresh
      var user = firebaseAuth.currentUser;
      if (user) await user.reload();

      showSuccess('Email verified!', continueUrl);
      // Auto-redirect after 2 seconds
      setTimeout(function () { window.location.href = continueUrl; }, 2000);

    } else if (mode === 'resetPassword') {
      pageTitle.textContent = 'Reset password';
      pageSubtitle.textContent = 'Choose a new password for your account.';
      loadingSection.classList.add('hidden');
      resetSection.classList.remove('hidden');

      resetBtn.addEventListener('click', async function () {
        resetError.classList.add('hidden');
        var newPw = document.getElementById('new-password').value;
        var confirmPw = document.getElementById('confirm-password').value;

        if (!newPw || newPw.length < 8) {
          resetError.textContent = 'Password must be at least 8 characters.';
          resetError.classList.remove('hidden');
          return;
        }
        if (newPw !== confirmPw) {
          resetError.textContent = 'Passwords do not match.';
          resetError.classList.remove('hidden');
          return;
        }

        resetBtn.disabled = true;
        resetBtn.textContent = 'Saving…';

        try {
          await auth.confirmPasswordReset(firebaseAuth, oobCode, newPw);
          showSuccess('Password updated! You can now sign in.', '/login');
        } catch (err) {
          resetBtn.disabled = false;
          resetBtn.textContent = 'Set New Password';
          resetError.textContent = err.message || 'Failed to reset password.';
          resetError.classList.remove('hidden');
        }
      });

    } else if (mode === 'recoverEmail') {
      pageTitle.textContent = 'Recovering email…';
      pageSubtitle.textContent = 'Restoring your previous email address.';

      await auth.applyActionCode(firebaseAuth, oobCode);
      showSuccess('Email address recovered. Please sign in again.', '/login');

    } else {
      showError('Unknown action mode: ' + mode);
    }
  }

  run().catch(function (err) {
    showError(err.message || 'Failed to complete the action. The link may have expired.');
  });
})();
</script>

</BaseLayout>
