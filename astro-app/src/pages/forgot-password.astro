---
import BaseLayout from '../layouts/BaseLayout.astro';
const fbApiKey = import.meta.env.PUBLIC_FIREBASE_API_KEY ?? '';
const fbAuthDomain = import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN ?? '';
---
<BaseLayout title="Forgot Password — Property Web Scraper">

<div id="fb-config" data-api-key={fbApiKey} data-auth-domain={fbAuthDomain} class="hidden"></div>

<section class="max-w-lg mx-auto px-4 py-12">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

    <div class="bg-gradient-to-br from-blue-600 to-blue-700 px-8 py-8 text-white">
      <h1 class="text-2xl font-bold mb-1">Reset password</h1>
      <p class="text-blue-100 text-sm">Enter your email and we'll send a reset link.</p>
    </div>

    <div id="form-section" class="px-8 py-8">
      <div class="mb-6">
        <label for="email-input" class="block text-sm font-semibold text-gray-700 mb-2">Email address</label>
        <input
          id="email-input"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>

      <p id="form-error" class="text-red-600 text-xs mb-4 hidden"></p>

      <button id="reset-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors cursor-pointer border-0">
        Send Reset Email
      </button>

      <p class="text-center text-xs text-gray-400 mt-4">
        <a href="/login" class="text-blue-600 hover:underline">Back to sign in</a>
      </p>
    </div>

    <!-- Success state -->
    <div id="success-section" class="hidden px-8 py-8">
      <div class="flex items-center gap-2 text-green-700 mb-4">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        <span class="font-semibold text-base">Check your inbox</span>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        If an account exists for <strong id="sent-to"></strong>, a password reset link has been sent.
      </p>
      <a href="/login"
        class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors no-underline">
        Back to Sign In
      </a>
    </div>

  </div>
</section>

<script is:inline>
(function () {
  var cfg = document.getElementById('fb-config');
  var apiKey = cfg && cfg.dataset.apiKey;
  var authDomain = cfg && cfg.dataset.authDomain;

  var emailInput = document.getElementById('email-input');
  var formError = document.getElementById('form-error');
  var resetBtn = document.getElementById('reset-btn');
  var formSection = document.getElementById('form-section');
  var successSection = document.getElementById('success-section');
  var sentTo = document.getElementById('sent-to');

  resetBtn.addEventListener('click', async function () {
    formError.classList.add('hidden');

    var email = emailInput.value.trim();
    if (!email || !email.includes('@')) {
      formError.textContent = 'Please enter a valid email address.';
      formError.classList.remove('hidden');
      return;
    }

    resetBtn.disabled = true;
    resetBtn.textContent = 'Sending…';

    try {
      var baseUrl = 'https://www.gstatic.com/firebasejs/11.3.1/';
      var app = await import(baseUrl + 'firebase-app.js');
      var auth = await import(baseUrl + 'firebase-auth.js');

      var firebaseApp = app.initializeApp({ apiKey: apiKey, authDomain: authDomain });
      var firebaseAuth = auth.getAuth(firebaseApp);

      await auth.sendPasswordResetEmail(firebaseAuth, email);

      sentTo.textContent = email;
      formSection.classList.add('hidden');
      successSection.classList.remove('hidden');
    } catch (err) {
      resetBtn.disabled = false;
      resetBtn.textContent = 'Send Reset Email';
      // Don't reveal whether the email exists — show generic success
      if (err.code === 'auth/user-not-found') {
        sentTo.textContent = email;
        formSection.classList.add('hidden');
        successSection.classList.remove('hidden');
      } else {
        formError.textContent = err.message || 'Something went wrong. Please try again.';
        formError.classList.remove('hidden');
      }
    }
  });

  emailInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') resetBtn.click();
  });
})();
</script>

</BaseLayout>
