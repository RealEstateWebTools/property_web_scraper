---
import BaseLayout from '../layouts/BaseLayout.astro';
const fbApiKey = import.meta.env.PUBLIC_FIREBASE_API_KEY ?? '';
const fbAuthDomain = import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN ?? '';
---
<BaseLayout title="My Account — Property Web Scraper">

<div id="fb-config" data-api-key={fbApiKey} data-auth-domain={fbAuthDomain} class="hidden"></div>

<section class="max-w-lg mx-auto px-4 py-12">
  <h1 class="text-2xl font-bold text-gray-900 mb-8">My Account</h1>

  <!-- Signed-out state -->
  <div id="signed-out-section" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
    <p class="text-gray-600 mb-4">Sign in to view your account and API key.</p>
    <a href="/login"
      class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl text-sm transition-colors no-underline">
      Sign In
    </a>
    <p class="text-xs text-gray-400 mt-4">
      No account yet? <a href="/register" class="text-blue-600 hover:underline">Create one</a>
    </p>
  </div>

  <!-- Email-not-verified state -->
  <div id="unverified-section" class="hidden bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
    <div class="bg-amber-50 border border-amber-100 rounded-xl px-4 py-3 text-sm text-amber-800 mb-4">
      <strong>Verify your email</strong> to access your API key.
    </div>
    <a href="/verify-email"
      class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors no-underline">
      Go to verification page
    </a>
  </div>

  <!-- Signed-in and verified state -->
  <div id="account-section" class="hidden">

    <!-- Welcome banner (shown after email verification) -->
    <div id="welcome-banner" class="hidden bg-green-50 border border-green-200 rounded-2xl px-6 py-4 mb-4 flex items-start gap-3">
      <svg class="mt-0.5 shrink-0 text-green-600" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
      <div>
        <p class="text-sm font-semibold text-green-800">Email verified — welcome aboard!</p>
        <p class="text-xs text-green-700 mt-0.5">Your API key has been generated below. Save it somewhere safe.</p>
      </div>
    </div>

    <!-- Profile card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Account</h2>
      <p class="text-sm text-gray-700">
        Signed in as <strong id="user-email"></strong>
      </p>
    </div>

    <!-- API Key card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">API Key</h2>

      <p class="text-sm text-gray-600 mb-4">
        Your API key is used by the Chrome extension and the API to authenticate requests.
        <strong>The key is shown once — save it somewhere safe.</strong>
      </p>

      <!-- Before key is fetched -->
      <div id="key-prompt">
        <p id="key-error" class="text-red-600 text-xs mb-3 hidden"></p>
        <button id="get-key-btn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors cursor-pointer border-0">
          Get My API Key
        </button>
      </div>

      <!-- After key is fetched -->
      <div id="key-display" class="hidden">
        <div class="relative mb-4">
          <code id="api-key-value"
            class="block w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-mono text-gray-800 break-all pr-20">
          </code>
          <button id="copy-btn"
            class="absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition-colors border-0 cursor-pointer font-semibold">
            Copy
          </button>
        </div>
        <p class="text-xs text-amber-700 bg-amber-50 rounded-lg px-3 py-2">
          This key will not be shown again. A new key will be generated each time you click the button above.
        </p>
      </div>
    </div>

    <!-- Extension setup card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Using the Chrome Extension</h2>
      <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
        <li>Open the extension popup and click the <strong>⚙️</strong> settings icon</li>
        <li>Paste your API key into the <strong>API Key</strong> field</li>
        <li>Click <strong>Save Settings</strong></li>
        <li>You can now create unlimited hauls from the extension</li>
      </ol>
    </div>

    <!-- Docs card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-4">Documentation</h2>
      <div class="space-y-2">
        <a href="/docs/api" class="flex items-center gap-2 text-sm text-blue-600 hover:underline">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          API Reference
        </a>
        <a href="/docs/get-html" class="flex items-center gap-2 text-sm text-blue-600 hover:underline">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          How to get page HTML
        </a>
        <a href="/sites" class="flex items-center gap-2 text-sm text-blue-600 hover:underline">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
          Supported sites
        </a>
      </div>
    </div>

    <!-- Plan card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-4">
      <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-3">Plan</h2>
      <div class="flex items-center justify-between">
        <div>
          <p class="font-semibold text-gray-900">Free</p>
          <p class="text-sm text-gray-500">500 extractions/day · Unlimited hauls</p>
        </div>
        <a href="/pricing"
          class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-xl transition-colors no-underline">
          Upgrade
        </a>
      </div>
    </div>

    <!-- Sign out -->
    <button id="signout-btn"
      class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-semibold py-3 px-6 rounded-xl text-sm transition-colors cursor-pointer border-0">
      Sign Out
    </button>

  </div>

  <!-- Loading state (shown while Firebase initialises) -->
  <div id="loading-section" class="text-center py-12 text-gray-400 text-sm">
    Loading…
  </div>

</section>

<script is:inline>
(function () {
  var cfg = document.getElementById('fb-config');
  var apiKey = cfg && cfg.dataset.apiKey;
  var authDomain = cfg && cfg.dataset.authDomain;

  var isWelcome = new URLSearchParams(window.location.search).has('welcome');

  var loadingSection = document.getElementById('loading-section');
  var signedOutSection = document.getElementById('signed-out-section');
  var unverifiedSection = document.getElementById('unverified-section');
  var accountSection = document.getElementById('account-section');
  var welcomeBanner = document.getElementById('welcome-banner');
  var userEmail = document.getElementById('user-email');
  var keyPrompt = document.getElementById('key-prompt');
  var keyDisplay = document.getElementById('key-display');
  var keyError = document.getElementById('key-error');
  var getKeyBtn = document.getElementById('get-key-btn');
  var apiKeyValue = document.getElementById('api-key-value');
  var copyBtn = document.getElementById('copy-btn');
  var signoutBtn = document.getElementById('signout-btn');

  var firebaseAuth = null;
  var authModule = null;

  function showSection(id) {
    ['loading-section', 'signed-out-section', 'unverified-section', 'account-section'].forEach(function (s) {
      document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
  }

  async function init() {
    if (!apiKey || !authDomain) {
      showSection('signed-out-section');
      return;
    }

    var baseUrl = 'https://www.gstatic.com/firebasejs/11.3.1/';
    var app = await import(baseUrl + 'firebase-app.js');
    authModule = await import(baseUrl + 'firebase-auth.js');

    var firebaseApp = app.initializeApp({ apiKey: apiKey, authDomain: authDomain });
    firebaseAuth = authModule.getAuth(firebaseApp);

    authModule.onAuthStateChanged(firebaseAuth, function (user) {
      if (!user) {
        showSection('signed-out-section');
        return;
      }
      if (!user.emailVerified) {
        showSection('unverified-section');
        return;
      }
      userEmail.textContent = user.email;
      showSection('account-section');

      if (isWelcome) {
        welcomeBanner.classList.remove('hidden');
        // Auto-generate the API key for first-time arrivals
        getKeyBtn.click();
      }
    });
  }

  getKeyBtn.addEventListener('click', async function () {
    keyError.classList.add('hidden');
    getKeyBtn.disabled = true;
    getKeyBtn.textContent = 'Generating key…';

    try {
      var user = firebaseAuth && firebaseAuth.currentUser;
      if (!user) throw new Error('Not signed in');

      var idToken = await user.getIdToken(/* forceRefresh */ true);

      var res = await fetch('/public_api/v1/account/api-key', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + idToken },
      });
      var data = await res.json();

      if (!res.ok) {
        throw new Error(data.error && data.error.message || 'Failed to generate key');
      }

      apiKeyValue.textContent = data.api_key || '';
      keyPrompt.classList.add('hidden');
      keyDisplay.classList.remove('hidden');
    } catch (err) {
      getKeyBtn.disabled = false;
      getKeyBtn.textContent = 'Get My API Key';
      keyError.textContent = err.message || 'Something went wrong.';
      keyError.classList.remove('hidden');
    }
  });

  copyBtn.addEventListener('click', function () {
    var key = apiKeyValue.textContent.trim();
    navigator.clipboard.writeText(key).then(function () {
      copyBtn.textContent = '✓ Copied';
      setTimeout(function () { copyBtn.textContent = 'Copy'; }, 2000);
    });
  });

  signoutBtn.addEventListener('click', async function () {
    if (firebaseAuth && authModule) {
      await authModule.signOut(firebaseAuth);
      window.location.href = '/';
    }
  });

  init().catch(function (err) {
    console.error('Firebase init failed:', err);
    showSection('signed-out-section');
  });
})();
</script>

</BaseLayout>
