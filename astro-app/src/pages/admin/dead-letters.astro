---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');
---
<AdminLayout title="Dead Letters — Admin" activePage="dead-letters">
  <h1 class="text-2xl font-bold mb-2">Dead-Letter Queue</h1>
  <p class="text-sm text-gray-500 mb-6">Failed operations captured for inspection. Entries expire after 30 days.</p>

  <!-- Loading -->
  <div id="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
    <p class="mt-3 text-sm text-gray-500">Loading dead-letter queue...</p>
  </div>

  <!-- Summary cards -->
  <div id="summary" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Total Entries</p>
      <p class="text-2xl font-bold" id="total-count">—</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Sources</p>
      <div class="text-sm mt-1" id="source-breakdown">—</div>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Latest Entry</p>
      <p class="text-sm font-medium mt-1" id="latest-entry">—</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5 flex items-end">
      <button
        id="clear-all-btn"
        class="px-4 py-2 bg-red-600 text-white rounded text-xs font-medium hover:bg-red-700 transition disabled:opacity-50"
        disabled
      >
        Clear All
      </button>
    </div>
  </div>

  <!-- Filter -->
  <div id="filter-bar" class="hidden mb-4 flex items-center gap-3">
    <select id="source-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
      <option value="">All sources</option>
    </select>
    <input
      id="search-input"
      type="text"
      placeholder="Search by operation or error..."
      class="flex-1 sm:max-w-xs border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
  </div>

  <!-- Results table -->
  <div id="results" class="hidden bg-white rounded-lg shadow">
    <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="font-semibold">Entries</h2>
      <button
        id="refresh-btn"
        class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition"
      >
        Refresh
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500 border-b border-gray-200">
            <th class="py-2 px-5 font-medium">Timestamp</th>
            <th class="py-2 px-5 font-medium">Source</th>
            <th class="py-2 px-5 font-medium">Operation</th>
            <th class="py-2 px-5 font-medium">Error</th>
            <th class="py-2 px-5 font-medium">Attempts</th>
            <th class="py-2 px-5 font-medium">Actions</th>
          </tr>
        </thead>
        <tbody id="results-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty state -->
  <div id="empty-state" class="hidden bg-green-50 rounded-lg p-8 text-center">
    <p class="text-green-700 font-medium">Queue is empty — no failed operations.</p>
  </div>

  <!-- Error -->
  <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm mt-4">
  </div>

  <script>
    function escapeHtml(str: unknown): string {
      return String(str == null ? '' : str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    interface DLEntry {
      id: string;
      timestamp: string;
      source: string;
      operation: string;
      error: string;
      context: Record<string, unknown>;
      attempts: number;
    }

    const sourceColors: Record<string, string> = {
      webhook: 'bg-purple-100 text-purple-700',
      firestore_write: 'bg-blue-100 text-blue-700',
      firestore_diagnostics: 'bg-blue-100 text-blue-700',
      kv_write: 'bg-amber-100 text-amber-700',
      price_history: 'bg-green-100 text-green-700',
      scrape_metadata: 'bg-gray-100 text-gray-600',
      usage: 'bg-red-100 text-red-700',
    };

    let allEntries: DLEntry[] = [];

    function renderTable(entries: DLEntry[]) {
      const bodyEl = document.getElementById('results-body')!;
      bodyEl.innerHTML = '';

      for (const e of entries) {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 hover:bg-gray-50';

        // Timestamp
        const tdTime = document.createElement('td');
        tdTime.className = 'py-2 px-5 text-gray-600 text-xs whitespace-nowrap';
        const d = new Date(e.timestamp);
        tdTime.textContent = d.toLocaleString();
        tdTime.title = e.timestamp;
        tr.appendChild(tdTime);

        // Source
        const tdSource = document.createElement('td');
        tdSource.className = 'py-2 px-5';
        const colorClass = sourceColors[e.source] || 'bg-gray-100 text-gray-600';
        tdSource.innerHTML = `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${colorClass}">${escapeHtml(e.source)}</span>`;
        tr.appendChild(tdSource);

        // Operation
        const tdOp = document.createElement('td');
        tdOp.className = 'py-2 px-5 font-mono text-xs max-w-[250px] truncate';
        tdOp.textContent = e.operation;
        tdOp.title = e.operation;
        tr.appendChild(tdOp);

        // Error
        const tdErr = document.createElement('td');
        tdErr.className = 'py-2 px-5 text-red-600 text-xs max-w-[300px] truncate';
        tdErr.textContent = e.error;
        tdErr.title = e.error;
        tr.appendChild(tdErr);

        // Attempts
        const tdAttempts = document.createElement('td');
        tdAttempts.className = 'py-2 px-5 text-center';
        tdAttempts.textContent = String(e.attempts);
        tr.appendChild(tdAttempts);

        // Actions
        const tdActions = document.createElement('td');
        tdActions.className = 'py-2 px-5';
        const ctxStr = JSON.stringify(e.context, null, 2);
        tdActions.innerHTML = `
          <button class="text-gray-500 hover:text-gray-700 text-xs mr-2 cursor-pointer border-0 bg-transparent context-btn" data-ctx="${encodeURIComponent(ctxStr)}" title="View context">
            <i class="bi bi-info-circle"></i>
          </button>
          <button class="text-red-500 hover:text-red-700 text-xs cursor-pointer border-0 bg-transparent dismiss-btn" data-id="${escapeHtml(e.id)}">
            <i class="bi bi-x-lg"></i> Dismiss
          </button>
        `;
        tr.appendChild(tdActions);

        bodyEl.appendChild(tr);
      }

      // Context buttons
      for (const btn of bodyEl.querySelectorAll('.context-btn')) {
        btn.addEventListener('click', (ev) => {
          const ctx = decodeURIComponent((ev.currentTarget as HTMLElement).dataset.ctx!);
          alert(ctx);
        });
      }

      // Dismiss buttons
      for (const btn of bodyEl.querySelectorAll('.dismiss-btn')) {
        btn.addEventListener('click', async (ev) => {
          const entryId = (ev.currentTarget as HTMLElement).dataset.id!;
          try {
            const res = await fetch('/admin/api/dead-letters', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'dismiss', entryId }),
            });
            const data = await res.json();
            if (data.success) loadEntries();
          } catch {
            // ignore
          }
        });
      }
    }

    function filterAndRender() {
      const sourceFilter = (document.getElementById('source-filter') as HTMLSelectElement)?.value || '';
      const query = (document.getElementById('search-input') as HTMLInputElement)?.value.toLowerCase() || '';

      let filtered = allEntries;
      if (sourceFilter) {
        filtered = filtered.filter((e) => e.source === sourceFilter);
      }
      if (query) {
        filtered = filtered.filter(
          (e) => e.operation.toLowerCase().includes(query) || e.error.toLowerCase().includes(query),
        );
      }
      renderTable(filtered);
    }

    async function loadEntries() {
      const loadingEl = document.getElementById('loading')!;
      const summaryEl = document.getElementById('summary')!;
      const filterBar = document.getElementById('filter-bar')!;
      const resultsEl = document.getElementById('results')!;
      const emptyEl = document.getElementById('empty-state')!;
      const errorEl = document.getElementById('error')!;
      const clearAllBtn = document.getElementById('clear-all-btn') as HTMLButtonElement;

      loadingEl.classList.remove('hidden');
      summaryEl.classList.add('hidden');
      filterBar.classList.add('hidden');
      resultsEl.classList.add('hidden');
      emptyEl.classList.add('hidden');
      errorEl.classList.add('hidden');

      try {
        const res = await fetch('/admin/api/dead-letters');
        if (!res.ok) {
          const data = await res.json().catch(() => ({ error: 'Request failed' }));
          errorEl.textContent = data.error || `HTTP ${res.status}`;
          errorEl.classList.remove('hidden');
          loadingEl.classList.add('hidden');
          return;
        }

        const data = await res.json();
        allEntries = data.entries || [];

        // Summary
        document.getElementById('total-count')!.textContent = String(data.total);

        const sourceBreakdown = document.getElementById('source-breakdown')!;
        const bySource: Record<string, number> = data.bySource || {};
        const sourceHtml = Object.entries(bySource)
          .sort((a, b) => b[1] - a[1])
          .map(([s, c]) => {
            const color = sourceColors[s] || 'bg-gray-100 text-gray-600';
            return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${color} mr-1 mb-1">${escapeHtml(s)}: ${escapeHtml(c)}</span>`;
          })
          .join('');
        sourceBreakdown.innerHTML = sourceHtml || '<span class="text-gray-400">none</span>';

        // Latest entry
        const latestEl = document.getElementById('latest-entry')!;
        if (allEntries.length > 0) {
          const latest = allEntries[0];
          const d = new Date(latest.timestamp);
          latestEl.textContent = d.toLocaleString();
        } else {
          latestEl.textContent = '—';
        }

        // Populate source filter
        const sourceSelect = document.getElementById('source-filter') as HTMLSelectElement;
        const currentVal = sourceSelect.value;
        sourceSelect.innerHTML = '<option value="">All sources</option>';
        for (const s of Object.keys(bySource).sort()) {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = `${s} (${bySource[s]})`;
          sourceSelect.appendChild(opt);
        }
        sourceSelect.value = currentVal;

        clearAllBtn.disabled = allEntries.length === 0;

        loadingEl.classList.add('hidden');
        summaryEl.classList.remove('hidden');

        if (allEntries.length === 0) {
          emptyEl.classList.remove('hidden');
        } else {
          filterBar.classList.remove('hidden');
          resultsEl.classList.remove('hidden');
          filterAndRender();
        }
      } catch (err) {
        errorEl.textContent = 'Network error: ' + (err instanceof Error ? err.message : String(err));
        errorEl.classList.remove('hidden');
        loadingEl.classList.add('hidden');
      }
    }

    // Clear all
    document.getElementById('clear-all-btn')?.addEventListener('click', async () => {
      if (!confirm('Clear all dead-letter entries? This cannot be undone.')) return;
      try {
        await fetch('/admin/api/dead-letters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'clear_all' }),
        });
        loadEntries();
      } catch {
        // ignore
      }
    });

    // Filter listeners
    document.getElementById('source-filter')?.addEventListener('change', filterAndRender);
    document.getElementById('search-input')?.addEventListener('input', filterAndRender);

    // Load on page ready
    loadEntries();

    // Refresh button
    document.getElementById('refresh-btn')?.addEventListener('click', loadEntries);
  </script>
</AdminLayout>
