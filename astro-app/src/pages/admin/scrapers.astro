---
import AdminLayout from '../../layouts/AdminLayout.astro';
import QualityBadge from '../../components/admin/QualityBadge.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';
import { allMappingNames, findByName } from '@lib/extractor/mapping-loader.js';
import { LOCAL_HOST_MAP } from '@lib/services/url-validator.js';
import { getAllScraperStats } from '@lib/services/extraction-stats.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');

const scraperStats = await getAllScraperStats();

// Sort: scrapers with extractions first (worst rate on top), then unused
const scrapers = [...scraperStats].sort((a, b) => {
  if (a.extractionCount > 0 && b.extractionCount === 0) return -1;
  if (a.extractionCount === 0 && b.extractionCount > 0) return 1;
  if (a.extractionCount > 0 && b.extractionCount > 0) return a.avgExtractionRate - b.avgExtractionRate;
  return a.name.localeCompare(b.name);
});

const activeCount = scrapers.filter(s => s.extractionCount > 0).length;
const totalRate = scrapers.reduce((sum, s) => sum + (s.extractionCount > 0 ? s.avgExtractionRate : 0), 0);
const avgRate = activeCount > 0 ? Math.round((totalRate / activeCount) * 100) : 0;

// Build fields data for test panel
const mappingNames = allMappingNames();
const scrapersForTest = mappingNames.map((name) => {
  const mapping = findByName(name);
  const textFields = Object.keys(mapping?.textFields ?? {});
  const intFields = Object.keys(mapping?.intFields ?? {});
  const floatFields = Object.keys(mapping?.floatFields ?? {});
  const booleanFields = Object.keys(mapping?.booleanFields ?? {});
  const allFields = [...textFields, ...intFields, ...floatFields, ...booleanFields];
  const defaultValues = Object.keys(mapping?.defaultValues ?? {});
  return { name, fields: allFields, defaultValues };
});
---
<AdminLayout title="Scrapers — Admin" activePage="scrapers">
  <h1 class="text-2xl font-bold mb-6">Scraper Management</h1>

  <!-- Summary cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Total Scrapers</p>
      <p class="text-2xl font-bold">{scrapers.length}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">With Host Mapping</p>
      <p class="text-2xl font-bold">{scrapers.filter(s => s.hosts.length > 0).length}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Active Scrapers</p>
      <p class="text-2xl font-bold">{activeCount}</p>
      <p class="text-xs text-gray-400 mt-1">with extractions</p>
    </div>
    <div class="bg-white rounded-lg shadow p-5">
      <p class="text-sm text-gray-500">Avg Quality</p>
      <p class="text-2xl font-bold">{activeCount > 0 ? `${avgRate}%` : '—'}</p>
      <p class="text-xs text-gray-400 mt-1">across active scrapers</p>
    </div>
  </div>

  <!-- Scraper list -->
  <div class="bg-white rounded-lg shadow mb-8">
    <div class="px-5 py-4 border-b border-gray-200">
      <h2 class="font-semibold">All Scrapers</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500 border-b border-gray-200">
            <th class="py-2 px-5 font-medium">Scraper</th>
            <th class="py-2 px-5 font-medium">Status</th>
            <th class="py-2 px-5 font-medium">Quality</th>
            <th class="py-2 px-5 font-medium">Avg Rate</th>
            <th class="py-2 px-5 font-medium">Extractions</th>
            <th class="py-2 px-5 font-medium">Expected</th>
            <th class="py-2 px-5 font-medium">Fields</th>
            <th class="py-2 px-5 font-medium">Images</th>
            <th class="py-2 px-5 font-medium">Actions</th>
          </tr>
        </thead>
        <tbody>
          {scrapers.map((s) => (
            <tr class="border-b border-gray-100 hover:bg-gray-50">
              <td class="py-2 px-5">
                <a href={`/admin/scrapers/${s.name}`} class="font-mono text-sm text-blue-600 hover:underline no-underline">{s.name}</a>
              </td>
              <td class="py-2 px-5">
                {s.loaded ? (
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">loaded</span>
                ) : (
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">not loaded</span>
                )}
              </td>
              <td class="py-2 px-5">
                {s.lastQualityGrade
                  ? <QualityBadge grade={s.lastQualityGrade} />
                  : <span class="text-gray-400 text-xs">n/a</span>
                }
              </td>
              <td class="py-2 px-5 text-gray-600">
                {s.extractionCount > 0 ? `${Math.round(s.avgExtractionRate * 100)}%` : '—'}
              </td>
              <td class="py-2 px-5 text-gray-600">{s.extractionCount}</td>
              <td class="py-2 px-5 text-gray-600">
                {s.expectedExtractionRate != null ? `${Math.round(s.expectedExtractionRate * 100)}%` : '—'}
              </td>
              <td class="py-2 px-5 text-gray-600">{s.fieldCount}</td>
              <td class="py-2 px-5">
                {s.hasImages ? (
                  <span class="text-green-600">yes</span>
                ) : (
                  <span class="text-gray-400">no</span>
                )}
              </td>
              <td class="py-2 px-5">
                <button
                  class="test-btn px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition"
                  data-scraper={s.name}
                >
                  Test
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Interactive test panel -->
  <div class="bg-white rounded-lg shadow" id="test-panel">
    <div class="px-5 py-4 border-b border-gray-200">
      <h2 class="font-semibold">Interactive Extraction Test</h2>
    </div>
    <div class="p-5 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Scraper</label>
          <select id="test-scraper" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Select a scraper...</option>
            {scrapers.map((s) => (
              <option value={s.name}>{s.name}</option>
            ))}
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Source URL</label>
          <input
            id="test-url"
            type="text"
            placeholder="https://www.example.com/listing/123"
            class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">HTML Content</label>
        <textarea
          id="test-html"
          rows="8"
          placeholder="Paste HTML here..."
          class="w-full px-3 py-2 border border-gray-300 rounded text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
      </div>
      <div class="flex items-center gap-3">
        <button
          id="run-test"
          class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition"
        >
          Run Extraction
        </button>
        <span id="test-status" class="text-sm text-gray-500"></span>
      </div>

      <!-- Diagnostics summary -->
      <div id="test-diagnostics" class="hidden">
      </div>

      <!-- Results: split pane -->
      <div id="test-results" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-sm font-semibold text-gray-700">Extraction Results</h3>
          <div class="flex gap-2">
            <button id="view-table-btn" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 font-medium">Table</button>
            <button id="view-json-btn" class="px-2 py-1 text-xs rounded bg-gray-100 text-gray-500 font-medium">JSON</button>
          </div>
        </div>

        <!-- Table view -->
        <div id="table-view" class="overflow-x-auto">
          <table class="w-full text-sm border border-gray-200 rounded">
            <thead>
              <tr class="text-left text-gray-500 bg-gray-50">
                <th class="py-2 px-3 font-medium">Field</th>
                <th class="py-2 px-3 font-medium">Value</th>
                <th class="py-2 px-3 font-medium">Type</th>
                <th class="py-2 px-3 font-medium">Importance</th>
                <th class="py-2 px-3 font-medium">Strategy</th>
              </tr>
            </thead>
            <tbody id="results-body">
            </tbody>
          </table>
        </div>

        <!-- JSON view -->
        <div id="json-view" class="hidden">
          <pre id="json-output" class="bg-gray-50 border border-gray-200 rounded p-4 text-xs font-mono overflow-auto max-h-96"></pre>
        </div>
      </div>

      <!-- Error -->
      <div id="test-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
      </div>
    </div>
  </div>

  <script>
    // Field importance map (mirrors quality-scorer.ts)
    const FIELD_IMPORTANCE: Record<string, string> = {
      title: 'critical', price_string: 'critical', price_float: 'critical',
      latitude: 'important', longitude: 'important', address_string: 'important',
      count_bedrooms: 'important', count_bathrooms: 'important', description: 'important',
      image_urls: 'important', reference: 'important',
    };

    const importanceBadge = (field: string) => {
      const imp = FIELD_IMPORTANCE[field] || 'optional';
      const colors: Record<string, string> = {
        critical: 'bg-red-50 text-red-600',
        important: 'bg-amber-50 text-amber-600',
        optional: 'bg-gray-50 text-gray-400',
      };
      return `<span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium ${colors[imp]}">${imp}</span>`;
    };

    // Handle "Test" button clicks in the scraper table
    document.querySelectorAll('.test-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        const scraper = (btn as HTMLElement).dataset.scraper || '';
        const selectEl = document.getElementById('test-scraper') as HTMLSelectElement;
        selectEl.value = scraper;
        document.getElementById('test-panel')?.scrollIntoView({ behavior: 'smooth' });
      });
    });

    // Toggle table/JSON views
    document.getElementById('view-table-btn')?.addEventListener('click', () => {
      document.getElementById('table-view')!.classList.remove('hidden');
      document.getElementById('json-view')!.classList.add('hidden');
      document.getElementById('view-table-btn')!.className = 'px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 font-medium';
      document.getElementById('view-json-btn')!.className = 'px-2 py-1 text-xs rounded bg-gray-100 text-gray-500 font-medium';
    });
    document.getElementById('view-json-btn')?.addEventListener('click', () => {
      document.getElementById('table-view')!.classList.add('hidden');
      document.getElementById('json-view')!.classList.remove('hidden');
      document.getElementById('view-json-btn')!.className = 'px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 font-medium';
      document.getElementById('view-table-btn')!.className = 'px-2 py-1 text-xs rounded bg-gray-100 text-gray-500 font-medium';
    });

    // Run extraction test
    document.getElementById('run-test')?.addEventListener('click', async () => {
      const scraper = (document.getElementById('test-scraper') as HTMLSelectElement).value;
      const sourceUrl = (document.getElementById('test-url') as HTMLInputElement).value;
      const html = (document.getElementById('test-html') as HTMLTextAreaElement).value;

      const statusEl = document.getElementById('test-status')!;
      const resultsEl = document.getElementById('test-results')!;
      const errorEl = document.getElementById('test-error')!;
      const bodyEl = document.getElementById('results-body')!;
      const diagEl = document.getElementById('test-diagnostics')!;

      resultsEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      diagEl.classList.add('hidden');
      diagEl.innerHTML = '';

      if (!scraper || !sourceUrl || !html) {
        errorEl.textContent = 'Please fill in scraper, source URL, and HTML content.';
        errorEl.classList.remove('hidden');
        return;
      }

      statusEl.textContent = 'Running...';

      try {
        const res = await fetch('/admin/scrapers/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scraper, html, sourceUrl }),
        });

        const data = await res.json();

        if (!res.ok) {
          errorEl.textContent = data.error || 'Request failed';
          errorEl.classList.remove('hidden');
          statusEl.textContent = '';
          return;
        }

        if (!data.success) {
          errorEl.textContent = data.errorMessage || 'Extraction failed';
          errorEl.classList.remove('hidden');
          statusEl.textContent = '';
          return;
        }

        const props = data.properties[0] || {};

        // Build field traces map from diagnostics
        const traces: Record<string, string> = {};
        if (data.diagnostics?.fieldTraces) {
          for (const [field, trace] of Object.entries(data.diagnostics.fieldTraces as Record<string, string>)) {
            traces[field] = trace as string;
          }
        }

        // Populate table
        bodyEl.innerHTML = '';
        const entries = Object.entries(props).sort(([a], [b]) => a.localeCompare(b));
        for (const [key, value] of entries) {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-100';

          const tdField = document.createElement('td');
          tdField.className = 'py-2 px-3 font-mono text-xs';
          tdField.textContent = key;

          const tdValue = document.createElement('td');
          tdValue.className = 'py-2 px-3 text-xs max-w-md truncate';
          if (Array.isArray(value)) {
            tdValue.textContent = `Array(${value.length})`;
            tdValue.title = JSON.stringify(value, null, 2);
          } else if (typeof value === 'string' && value.length > 100) {
            tdValue.textContent = value.substring(0, 100) + '...';
            tdValue.title = value;
          } else {
            tdValue.textContent = String(value);
          }

          const tdType = document.createElement('td');
          tdType.className = 'py-2 px-3 text-xs text-gray-400';
          tdType.textContent = Array.isArray(value) ? 'array' : typeof value;

          const tdImp = document.createElement('td');
          tdImp.className = 'py-2 px-3';
          tdImp.innerHTML = importanceBadge(key);

          const tdStrategy = document.createElement('td');
          tdStrategy.className = 'py-2 px-3 font-mono text-[10px] text-gray-400 max-w-xs truncate';
          tdStrategy.textContent = traces[key] || '—';
          tdStrategy.title = traces[key] || '';

          tr.appendChild(tdField);
          tr.appendChild(tdValue);
          tr.appendChild(tdType);
          tr.appendChild(tdImp);
          tr.appendChild(tdStrategy);
          bodyEl.appendChild(tr);
        }

        // Populate JSON view
        document.getElementById('json-output')!.textContent = JSON.stringify(props, null, 2);

        resultsEl.classList.remove('hidden');

        // Show diagnostics summary with quality grade
        if (data.diagnostics) {
          const diag = data.diagnostics;
          const gradeColors: Record<string, string> = {
            A: 'bg-green-50 border-green-200 text-green-800',
            B: 'bg-blue-50 border-blue-200 text-blue-800',
            C: 'bg-amber-50 border-amber-200 text-amber-800',
            F: 'bg-red-50 border-red-200 text-red-800',
          };
          const colorClass = gradeColors[diag.qualityGrade] || gradeColors.F;
          let diagHtml = `<div class="${colorClass} border rounded px-4 py-3 text-sm">`;
          diagHtml += `<strong>Grade ${diag.qualityGrade}</strong>: `;
          diagHtml += `<strong>${diag.populatedFields}/${diag.totalFields}</strong> fields populated`;
          diagHtml += ` (${Math.round((diag.extractionRate || 0) * 100)}%)`;
          diagHtml += ` using <span class="font-mono">${diag.scraperName}</span>`;
          if (diag.emptyFields && diag.emptyFields.length > 0) {
            diagHtml += `<div class="mt-1 text-xs">Empty: ${diag.emptyFields.join(', ')}</div>`;
          }
          diagHtml += '</div>';
          diagEl.innerHTML = diagHtml;
          diagEl.classList.remove('hidden');
        }

        statusEl.textContent = `Extracted ${entries.length} fields`;
      } catch (err) {
        errorEl.textContent = 'Network error: ' + (err instanceof Error ? err.message : String(err));
        errorEl.classList.remove('hidden');
        statusEl.textContent = '';
      }
    });
  </script>
</AdminLayout>
