---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import QualityBadge from '../../../components/QualityBadge.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';
import { getListing, getDiagnostics } from '@lib/services/listing-store.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');

const { id } = Astro.params;
const listing = id ? await getListing(id) : undefined;
const diagnostics = id ? await getDiagnostics(id) : undefined;

const grade = diagnostics?.qualityGrade || 'F';
const ratePercent = diagnostics ? Math.round(diagnostics.extractionRate * 100) : 0;
const weightedPercent = diagnostics?.weightedExtractionRate != null
  ? Math.round(diagnostics.weightedExtractionRate * 100)
  : null;
const expectedPercent = diagnostics?.expectedExtractionRate != null
  ? Math.round(diagnostics.expectedExtractionRate * 100)
  : null;
const criticalMissing = diagnostics?.criticalFieldsMissing || [];
const contentAnalysis = diagnostics?.contentAnalysis;

const gradeColors: Record<string, { bg: string; text: string; border: string }> = {
  A: { bg: 'bg-green-50', text: 'text-green-800', border: 'border-green-200' },
  B: { bg: 'bg-blue-50', text: 'text-blue-800', border: 'border-blue-200' },
  C: { bg: 'bg-amber-50', text: 'text-amber-800', border: 'border-amber-200' },
  F: { bg: 'bg-red-50', text: 'text-red-800', border: 'border-red-200' },
};
const colors = gradeColors[grade] || gradeColors.F;
---
<AdminLayout title={`Extraction ${id} — Admin`} activePage="extractions">
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-500 mb-4">
    <a href="/admin" class="hover:underline no-underline text-gray-500">Dashboard</a>
    <span class="mx-1">/</span>
    <a href="/admin/extractions" class="hover:underline no-underline text-gray-500">Extractions</a>
    <span class="mx-1">/</span>
    <span class="text-gray-800 font-medium">{diagnostics?.scraperName || id}</span>
  </nav>

  {!listing ? (
    <div class="bg-amber-50 rounded-lg p-6 text-center">
      <p class="text-amber-800 font-medium">Extraction not found</p>
      <p class="text-amber-700 text-sm mt-1">This result may have expired or the ID is invalid.</p>
    </div>
  ) : (
    <>
      {/* Top banner */}
      {diagnostics && (
        <>
          <div class={`flex items-center gap-3 ${colors.bg} ${colors.text} border ${colors.border} px-5 py-3 rounded-lg mb-2 font-medium`}>
            <QualityBadge grade={grade} size="md" />
            <span>{diagnostics.qualityLabel} — {diagnostics.populatedExtractableFields}/{diagnostics.extractableFields} fields ({ratePercent}%{weightedPercent != null ? `, weighted ${weightedPercent}%` : ''})</span>
          </div>
          {criticalMissing.length > 0 && (
            <div class="flex items-center gap-2 bg-red-50 border border-red-200 text-red-800 px-4 py-2 rounded-lg mb-2 text-sm">
              <i class="bi bi-exclamation-octagon"></i>
              Critical fields missing: {criticalMissing.join(', ')}
            </div>
          )}
        </>
      )}
      {(listing as any).manual_override && (
        <div class="flex items-center gap-2 bg-purple-50 border border-purple-200 text-purple-800 px-4 py-2 rounded-lg mb-2 text-sm">
          <i class="bi bi-pencil-square"></i>
          Manual override — fields have been manually edited
        </div>
      )}
      {diagnostics && !diagnostics.meetsExpectation && diagnostics.expectedExtractionRate != null && (
        <div class="flex items-center gap-2 bg-amber-50 border border-amber-200 text-amber-800 px-4 py-2 rounded-lg mb-4 text-sm">
          <i class="bi bi-exclamation-triangle"></i>
          Below expected rate of {expectedPercent}% for {diagnostics.scraperName}
        </div>
      )}
      {diagnostics?.meetsExpectation && <div class="mb-4"></div>}

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left column -->
        <div class="lg:col-span-2 space-y-6">
          {/* Summary card */}
          <div class="bg-white rounded-lg shadow p-5">
            <h2 class="font-semibold mb-3">Summary</h2>
            <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
              <dt class="text-gray-500">Scraper</dt>
              <dd>
                <a href={`/admin/scrapers/${diagnostics?.scraperName}`} class="font-mono text-blue-600 hover:underline no-underline">
                  {diagnostics?.scraperName || '—'}
                </a>
              </dd>
              <dt class="text-gray-500">Source URL</dt>
              <dd class="truncate" title={(listing as any).import_url}>{(listing as any).import_url || '—'}</dd>
              <dt class="text-gray-500">Title</dt>
              <dd>{(listing as any).title || '—'}</dd>
              <dt class="text-gray-500">Price</dt>
              <dd>{(listing as any).price_string || '—'}</dd>
            </dl>
          </div>

          {/* Edit Fields */}
          <div class="bg-white rounded-lg shadow">
            <button
              id="toggle-edit"
              type="button"
              class="w-full flex items-center justify-between px-5 py-4 border-b border-gray-200 cursor-pointer bg-transparent hover:bg-gray-50 transition"
            >
              <h2 class="font-semibold flex items-center gap-2">
                <i class="bi bi-pencil"></i> Edit Fields
              </h2>
              <i id="toggle-edit-icon" class="bi bi-chevron-down text-gray-400 transition-transform"></i>
            </button>
            <div id="edit-section" class="hidden px-5 py-4">
              <form id="edit-fields-form" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-3">
                {/* Text fields */}
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-title">Title</label>
                  <input id="ef-title" name="title" type="text" value={(listing as any).title || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-price_string">Price String</label>
                  <input id="ef-price_string" name="price_string" type="text" value={(listing as any).price_string || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-price_float">Price (numeric)</label>
                  <input id="ef-price_float" name="price_float" type="number" step="any" value={(listing as any).price_float || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-price_currency">Price Currency</label>
                  <input id="ef-price_currency" name="price_currency" type="text" value={(listing as any).price_currency || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-address_string">Address</label>
                  <input id="ef-address_string" name="address_string" type="text" value={(listing as any).address_string || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-city">City</label>
                  <input id="ef-city" name="city" type="text" value={(listing as any).city || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-region">Region</label>
                  <input id="ef-region" name="region" type="text" value={(listing as any).region || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-country">Country</label>
                  <input id="ef-country" name="country" type="text" value={(listing as any).country || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-postal_code">Postal Code</label>
                  <input id="ef-postal_code" name="postal_code" type="text" value={(listing as any).postal_code || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-property_type">Property Type</label>
                  <input id="ef-property_type" name="property_type" type="text" value={(listing as any).property_type || ''} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                {/* Numeric fields */}
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-count_bedrooms">Bedrooms</label>
                  <input id="ef-count_bedrooms" name="count_bedrooms" type="number" value={(listing as any).count_bedrooms || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-count_bathrooms">Bathrooms</label>
                  <input id="ef-count_bathrooms" name="count_bathrooms" type="number" step="any" value={(listing as any).count_bathrooms || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-constructed_area">Constructed Area</label>
                  <input id="ef-constructed_area" name="constructed_area" type="number" step="any" value={(listing as any).constructed_area || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-plot_area">Plot Area</label>
                  <input id="ef-plot_area" name="plot_area" type="number" step="any" value={(listing as any).plot_area || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-latitude">Latitude</label>
                  <input id="ef-latitude" name="latitude" type="number" step="any" value={(listing as any).latitude || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-longitude">Longitude</label>
                  <input id="ef-longitude" name="longitude" type="number" step="any" value={(listing as any).longitude || 0} class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                {/* Description - full width */}
                <div class="sm:col-span-2">
                  <label class="block text-xs font-medium text-gray-500 mb-1" for="ef-description">Description</label>
                  <textarea id="ef-description" name="description" rows="3" class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">{(listing as any).description || ''}</textarea>
                </div>
              </form>
              <div class="flex items-center gap-3 mt-4">
                <button id="save-fields-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition">
                  <i class="bi bi-check-lg mr-1"></i> Save Changes
                </button>
                <span id="edit-feedback" class="text-sm hidden"></span>
              </div>
            </div>
          </div>

          {/* Field Traces table */}
          {diagnostics && diagnostics.fieldTraces.length > 0 && (
            <div class="bg-white rounded-lg shadow">
              <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="font-semibold">Field Traces</h2>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="text-left text-gray-500 bg-gray-50">
                      <th class="py-1.5 px-3 font-medium">Field</th>
                      <th class="py-1.5 px-3 font-medium">Section</th>
                      <th class="py-1.5 px-3 font-medium">Strategy</th>
                      <th class="py-1.5 px-3 font-medium">Raw Text</th>
                      <th class="py-1.5 px-3 font-medium">Value</th>
                      <th class="py-1.5 px-3 font-medium"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {diagnostics.fieldTraces.map((trace) => {
                      const isEmpty = trace.rawText === '' || trace.value === 0 || trace.value === false || trace.value === '';
                      return (
                        <tr class={`border-b border-gray-100 ${isEmpty ? 'bg-red-50' : ''}`}>
                          <td class="py-1.5 px-3 font-mono">{trace.field}</td>
                          <td class="py-1.5 px-3 text-gray-500">{trace.section}</td>
                          <td class="py-1.5 px-3 text-gray-500 max-w-[200px] truncate" title={trace.strategy}>
                            {trace.strategy}
                            {(trace as any).fallbackUsed != null && (
                              <span class="ml-1 text-amber-600 text-[10px]">[fb {(trace as any).fallbackUsed}]</span>
                            )}
                          </td>
                          <td class="py-1.5 px-3 max-w-[200px] truncate" title={trace.rawText}>
                            {trace.rawText || <span class="text-red-400 italic">empty</span>}
                          </td>
                          <td class="py-1.5 px-3 max-w-[200px] truncate" title={String(trace.value)}>
                            {JSON.stringify(trace.value)}
                          </td>
                          <td class="py-1.5 px-3">
                            {isEmpty
                              ? <span class="text-red-500"><i class="bi bi-x-circle"></i></span>
                              : <span class="text-green-500"><i class="bi bi-check-circle"></i></span>
                            }
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>

        <!-- Right column -->
        <div class="space-y-6">
          {/* Quality Breakdown */}
          {diagnostics && (
            <div class="bg-white rounded-lg shadow p-5">
              <h2 class="font-semibold mb-3">Quality Breakdown</h2>
              <div class="text-center mb-4">
                <QualityBadge grade={grade} size="md" />
                <p class="text-2xl font-bold mt-2">{ratePercent}%</p>
                {weightedPercent != null && (
                  <p class="text-sm text-gray-500">Weighted: {weightedPercent}%</p>
                )}
                <p class="text-xs text-gray-500">{diagnostics.qualityLabel}</p>
              </div>
              <dl class="text-sm space-y-2">
                {expectedPercent != null && (
                  <>
                    <dt class="text-gray-500">Expected Rate</dt>
                    <dd class="font-medium">{expectedPercent}%</dd>
                  </>
                )}
                <dt class="text-gray-500">Extractable Fields</dt>
                <dd class="font-medium">{diagnostics.extractableFields}</dd>
                <dt class="text-gray-500">Populated</dt>
                <dd class="font-medium">{diagnostics.populatedExtractableFields}</dd>
                <dt class="text-gray-500">Total Fields</dt>
                <dd class="font-medium">{diagnostics.totalFields}</dd>
                <dt class="text-gray-500">Total Populated</dt>
                <dd class="font-medium">{diagnostics.populatedFields}</dd>
              </dl>
            </div>
          )}

          {/* Empty Fields */}
          {diagnostics && diagnostics.emptyFields.length > 0 && (
            <div class="bg-white rounded-lg shadow p-5">
              <h2 class="font-semibold mb-3">Empty Fields</h2>
              <div class="flex flex-wrap gap-1.5">
                {diagnostics.emptyFields.map(f => (
                  <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700">{f}</span>
                ))}
              </div>
            </div>
          )}

          {/* Content Analysis */}
          {contentAnalysis && (
            <div class="bg-white rounded-lg shadow p-5">
              <h2 class="font-semibold mb-3">Content Analysis</h2>
              <dl class="text-sm space-y-2">
                <dt class="text-gray-500">HTML Size</dt>
                <dd class="font-medium">{Math.round(contentAnalysis.htmlLength / 1024)} KB</dd>
                <dt class="text-gray-500">JSON-LD Blocks</dt>
                <dd class="font-medium">{contentAnalysis.jsonLdCount}</dd>
                {contentAnalysis.scriptJsonVarsFound.length > 0 && (
                  <>
                    <dt class="text-gray-500">Script Vars</dt>
                    <dd class="font-medium font-mono text-xs">{contentAnalysis.scriptJsonVarsFound.join(', ')}</dd>
                  </>
                )}
              </dl>
              {contentAnalysis.appearsBlocked && (
                <div class="mt-3 px-3 py-2 bg-red-50 border border-red-200 text-red-700 text-xs rounded">
                  <i class="bi bi-shield-exclamation mr-1"></i> Page appears blocked (bot detection)
                </div>
              )}
              {contentAnalysis.appearsJsOnly && (
                <div class="mt-3 px-3 py-2 bg-amber-50 border border-amber-200 text-amber-700 text-xs rounded">
                  <i class="bi bi-code-slash mr-1"></i> JS-only shell detected
                </div>
              )}
            </div>
          )}

          {/* Quick Actions */}
          <div class="bg-white rounded-lg shadow p-5">
            <h2 class="font-semibold mb-3">Quick Actions</h2>
            <div class="space-y-2">
              <a href={`/listings/${id}`} class="block text-sm text-blue-600 hover:underline no-underline">
                <i class="bi bi-eye mr-1"></i> View listing
              </a>
              <a href={`/listings/${id}.json`} class="block text-sm text-blue-600 hover:underline no-underline">
                <i class="bi bi-braces mr-1"></i> View JSON
              </a>
              {diagnostics?.scraperName && (
                <a href={`/admin/scrapers/${diagnostics.scraperName}`} class="block text-sm text-blue-600 hover:underline no-underline">
                  <i class="bi bi-cpu mr-1"></i> Scraper detail
                </a>
              )}
            </div>
          </div>
        </div>
      </div>
    </>
  )}
  <script define:vars={{ listingId: id }}>
    // Toggle edit section
    const toggleBtn = document.getElementById('toggle-edit');
    const editSection = document.getElementById('edit-section');
    const toggleIcon = document.getElementById('toggle-edit-icon');
    if (toggleBtn && editSection && toggleIcon) {
      toggleBtn.addEventListener('click', () => {
        const hidden = editSection.classList.toggle('hidden');
        toggleIcon.style.transform = hidden ? '' : 'rotate(180deg)';
      });
    }

    // Save fields
    const saveBtn = document.getElementById('save-fields-btn');
    const feedback = document.getElementById('edit-feedback');
    const form = document.getElementById('edit-fields-form');
    if (saveBtn && feedback && form) {
      saveBtn.addEventListener('click', async () => {
        const numericFields = new Set([
          'price_float', 'count_bedrooms', 'count_bathrooms',
          'constructed_area', 'plot_area', 'latitude', 'longitude',
        ]);
        const fields = {};
        const inputs = form.querySelectorAll('input, textarea');
        for (const input of inputs) {
          const name = input.getAttribute('name');
          if (!name) continue;
          if (numericFields.has(name)) {
            fields[name] = parseFloat(input.value) || 0;
          } else {
            fields[name] = input.value;
          }
        }

        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        feedback.classList.add('hidden');

        try {
          const res = await fetch('/admin/api/listings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'update_fields', listingId, fields }),
          });
          const data = await res.json();
          if (data.success) {
            feedback.textContent = `Updated ${data.updated.length} field(s)`;
            feedback.className = 'text-sm text-green-600';
            feedback.classList.remove('hidden');
          } else {
            feedback.textContent = data.error || 'Save failed';
            feedback.className = 'text-sm text-red-600';
            feedback.classList.remove('hidden');
          }
        } catch (err) {
          feedback.textContent = 'Network error: ' + (err instanceof Error ? err.message : String(err));
          feedback.className = 'text-sm text-red-600';
          feedback.classList.remove('hidden');
        } finally {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="bi bi-check-lg mr-1"></i> Save Changes';
        }
      });
    }
  </script>
</AdminLayout>
