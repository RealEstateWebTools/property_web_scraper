---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';
import { getAllExportHistory } from '@lib/services/export-history.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');

const exports = await getAllExportHistory(200);

const formatCounts: Record<string, number> = {};
for (const entry of exports) {
  formatCounts[entry.format] = (formatCounts[entry.format] || 0) + 1;
}

function timeAgo(ts: number): string {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  return `${Math.floor(diff / 86400000)}d ago`;
}

function truncate(str: string, len: number): string {
  return str.length > len ? str.slice(0, len) + '...' : str;
}
---
<AdminLayout title="Exports â€” Admin" activePage="exports">
  <h1 class="text-2xl font-bold mb-6">Export History</h1>

  <!-- Summary -->
  <div class="bg-white rounded-lg shadow mb-6 p-4">
    <div class="flex flex-wrap gap-4 text-sm">
      <div>
        <span class="text-gray-500">Total exports:</span>
        <span class="font-semibold ml-1">{exports.length}</span>
      </div>
      {Object.entries(formatCounts).map(([format, count]) => (
        <div>
          <span class="text-gray-500">{format.toUpperCase()}:</span>
          <span class="font-semibold ml-1">{count}</span>
        </div>
      ))}
    </div>
  </div>

  <!-- Exports table -->
  <div class="bg-white rounded-lg shadow">
    <div class="overflow-x-auto">
      {exports.length === 0 ? (
        <div class="p-8 text-center text-gray-400 text-sm">No exports recorded yet</div>
      ) : (
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 border-b border-gray-200">
              <th class="py-2 px-4 font-medium">Time</th>
              <th class="py-2 px-4 font-medium">User</th>
              <th class="py-2 px-4 font-medium">Format</th>
              <th class="py-2 px-4 font-medium">Listings</th>
              <th class="py-2 px-4 font-medium">Filename</th>
            </tr>
          </thead>
          <tbody>
            {exports.map((entry) => (
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-2 px-4 text-xs text-gray-500 whitespace-nowrap">{timeAgo(entry.timestamp)}</td>
                <td class="py-2 px-4 text-xs font-mono">{truncate(entry.userId, 20)}</td>
                <td class="py-2 px-4">
                  <span class={`inline-block text-xs font-medium px-2 py-0.5 rounded ${
                    entry.format === 'json' ? 'bg-blue-100 text-blue-700' :
                    entry.format === 'csv' ? 'bg-green-100 text-green-700' :
                    entry.format === 'geojson' ? 'bg-orange-100 text-orange-700' :
                    entry.format === 'xml' ? 'bg-purple-100 text-purple-700' :
                    entry.format === 'schema-org' ? 'bg-teal-100 text-teal-700' :
                    entry.format === 'icalendar' ? 'bg-pink-100 text-pink-700' :
                    'bg-gray-100 text-gray-700'
                  }`}>
                    {entry.format.toUpperCase()}
                  </span>
                </td>
                <td class="py-2 px-4 text-xs">{entry.listingCount}</td>
                <td class="py-2 px-4 text-xs font-mono max-w-[250px] truncate" title={entry.filename}>
                  {truncate(entry.filename, 45)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  </div>
</AdminLayout>
