---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');
---
<AdminLayout title="Data Retention â€” Admin" activePage="retention">
  <h1 class="text-2xl font-bold mb-2">Data Retention</h1>
  <p class="text-sm text-gray-500 mb-6">Configure TTL policies per collection and run manual cleanup. Listings are exempt and never expired.</p>

  <!-- Loading -->
  <div id="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
    <p class="mt-3 text-sm text-gray-500">Loading retention config...</p>
  </div>

  <!-- Policy table -->
  <div id="policies" class="hidden bg-white rounded-lg shadow mb-8">
    <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="font-semibold">Retention Policies</h2>
      <button
        id="refresh-btn"
        class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition"
      >
        Refresh
      </button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500 border-b border-gray-200">
            <th class="py-2 px-5 font-medium">Collection</th>
            <th class="py-2 px-5 font-medium">TTL (days)</th>
            <th class="py-2 px-5 font-medium">Description</th>
          </tr>
        </thead>
        <tbody id="policies-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Cleanup section -->
  <div id="cleanup-section" class="hidden bg-white rounded-lg shadow mb-8">
    <div class="px-5 py-4 border-b border-gray-200">
      <h2 class="font-semibold">Manual Cleanup</h2>
    </div>
    <div class="p-5">
      <p class="text-sm text-gray-600 mb-4">
        Run cleanup manually to delete expired documents. Use dry-run to preview what would be deleted.
      </p>
      <div class="flex gap-3 mb-4">
        <button
          id="dry-run-btn"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-medium hover:bg-gray-300 transition"
        >
          Dry Run
        </button>
        <button
          id="cleanup-btn"
          class="px-4 py-2 bg-red-600 text-white rounded text-sm font-medium hover:bg-red-700 transition"
        >
          Run Cleanup
        </button>
      </div>
      <div id="cleanup-status" class="hidden text-sm text-gray-500">Running...</div>
      <div id="cleanup-result" class="hidden"></div>
    </div>
  </div>

  <!-- Last cleanup result -->
  <div id="last-cleanup" class="hidden bg-white rounded-lg shadow">
    <div class="px-5 py-4 border-b border-gray-200">
      <h2 class="font-semibold">Last Cleanup Result</h2>
    </div>
    <div id="last-cleanup-body" class="p-5 text-sm text-gray-600">
    </div>
  </div>

  <!-- Error -->
  <div id="error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm mt-4">
  </div>

  <script>
    function escapeHtml(str: unknown): string {
      return String(str == null ? '' : str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatTime(ts: number): string {
      return new Date(ts).toLocaleString();
    }

    function renderCleanupResult(result: any, container: HTMLElement) {
      if (!result) {
        container.innerHTML = '<p class="text-gray-400">No cleanup has been run yet.</p>';
        return;
      }
      let html = `<div class="space-y-2">`;
      html += `<p><strong>${result.dryRun ? 'Dry Run' : 'Cleanup'}</strong> at ${formatTime(result.timestamp)} (${result.durationMs}ms)</p>`;
      html += `<p>Collections processed: ${result.collectionsProcessed}, Documents deleted: ${result.totalDocumentsDeleted}</p>`;

      if (result.details && result.details.length > 0) {
        html += `<table class="w-full text-xs border border-gray-200 rounded mt-2">`;
        html += `<thead><tr class="text-left text-gray-500 bg-gray-100">
          <th class="py-1 px-2 font-medium">Collection</th>
          <th class="py-1 px-2 font-medium">TTL</th>
          <th class="py-1 px-2 font-medium">Total</th>
          <th class="py-1 px-2 font-medium">Expired</th>
          <th class="py-1 px-2 font-medium">Deleted</th>
        </tr></thead><tbody>`;

        for (const d of result.details) {
          const highlight = d.expiredDocs > 0 ? 'bg-amber-50' : '';
          html += `<tr class="border-b border-gray-100 ${highlight}">
            <td class="py-1 px-2 font-mono">${escapeHtml(d.collection)}</td>
            <td class="py-1 px-2">${escapeHtml(d.ttlDays)}d</td>
            <td class="py-1 px-2">${escapeHtml(d.totalDocs)}</td>
            <td class="py-1 px-2">${escapeHtml(d.expiredDocs)}</td>
            <td class="py-1 px-2 font-medium">${escapeHtml(d.deletedDocs)}</td>
          </tr>`;
        }
        html += `</tbody></table>`;
      }
      html += `</div>`;
      container.innerHTML = html;
    }

    async function loadConfig() {
      const loadingEl = document.getElementById('loading')!;
      const policiesEl = document.getElementById('policies')!;
      const cleanupSection = document.getElementById('cleanup-section')!;
      const lastCleanupEl = document.getElementById('last-cleanup')!;
      const errorEl = document.getElementById('error')!;

      loadingEl.classList.remove('hidden');
      policiesEl.classList.add('hidden');
      cleanupSection.classList.add('hidden');
      lastCleanupEl.classList.add('hidden');
      errorEl.classList.add('hidden');

      try {
        const res = await fetch('/admin/api/retention');
        if (!res.ok) {
          const data = await res.json().catch(() => ({ error: 'Request failed' }));
          errorEl.textContent = data.error || `HTTP ${res.status}`;
          errorEl.classList.remove('hidden');
          loadingEl.classList.add('hidden');
          return;
        }

        const data = await res.json();
        const config = data.config;
        const policies = config?.policies || [];

        // Render policies
        const tbody = document.getElementById('policies-body')!;
        tbody.innerHTML = '';
        for (const p of policies) {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-gray-100 hover:bg-gray-50';
          tr.innerHTML = `
            <td class="py-2 px-5 font-mono text-sm">${escapeHtml(p.collectionName)}</td>
            <td class="py-2 px-5">${escapeHtml(p.ttlDays)}</td>
            <td class="py-2 px-5 text-gray-500">${escapeHtml(p.description)}</td>
          `;
          tbody.appendChild(tr);
        }

        // Render last cleanup
        if (data.lastCleanup) {
          renderCleanupResult(data.lastCleanup, document.getElementById('last-cleanup-body')!);
          lastCleanupEl.classList.remove('hidden');
        }

        loadingEl.classList.add('hidden');
        policiesEl.classList.remove('hidden');
        cleanupSection.classList.remove('hidden');
      } catch (err) {
        errorEl.textContent = 'Network error: ' + (err instanceof Error ? err.message : String(err));
        errorEl.classList.remove('hidden');
        loadingEl.classList.add('hidden');
      }
    }

    async function triggerCleanup(dryRun: boolean) {
      const statusEl = document.getElementById('cleanup-status')!;
      const resultEl = document.getElementById('cleanup-result')!;
      statusEl.textContent = dryRun ? 'Running dry run...' : 'Running cleanup...';
      statusEl.classList.remove('hidden');
      resultEl.classList.add('hidden');

      try {
        const res = await fetch('/admin/api/retention', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'cleanup', dryRun }),
        });
        const data = await res.json();
        statusEl.classList.add('hidden');
        resultEl.classList.remove('hidden');
        renderCleanupResult(data.result, resultEl);
      } catch (err) {
        statusEl.textContent = 'Error: ' + (err instanceof Error ? err.message : String(err));
      }
    }

    loadConfig();
    document.getElementById('refresh-btn')?.addEventListener('click', loadConfig);
    document.getElementById('dry-run-btn')?.addEventListener('click', () => triggerCleanup(true));
    document.getElementById('cleanup-btn')?.addEventListener('click', () => triggerCleanup(false));
  </script>
</AdminLayout>
