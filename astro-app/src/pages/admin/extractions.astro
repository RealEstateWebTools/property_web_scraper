---
import AdminLayout from '../../layouts/AdminLayout.astro';
import QualityBadge from '../../components/QualityBadge.astro';
import { authenticateAdmin } from '@lib/services/admin-auth.js';
import { getRecentExtractions } from '@lib/services/extraction-stats.js';
import { allMappingNames } from '@lib/extractor/mapping-loader.js';

const auth = authenticateAdmin(Astro.request);
if (!auth.authorized) return Astro.redirect('/admin/login');

const url = new URL(Astro.request.url);
const filterScraper = url.searchParams.get('scraper') || '';
const filterGrade = url.searchParams.get('grade') || '';
const filterSearch = url.searchParams.get('search') || '';

let extractions = await getRecentExtractions(200);
const totalCount = extractions.length;

if (filterScraper) {
  extractions = extractions.filter(e => e.scraperName === filterScraper);
}
if (filterGrade) {
  extractions = extractions.filter(e => e.qualityGrade === filterGrade);
}
if (filterSearch) {
  const q = filterSearch.toLowerCase();
  extractions = extractions.filter(e =>
    e.sourceUrl.toLowerCase().includes(q) || e.title.toLowerCase().includes(q)
  );
}

const mappingNames = allMappingNames();

const gradeCounts = { A: 0, B: 0, C: 0, F: 0 };
for (const ext of extractions) {
  gradeCounts[ext.qualityGrade as keyof typeof gradeCounts]++;
}

function timeAgo(ts: number): string {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  return `${Math.floor(diff / 86400000)}d ago`;
}

function truncate(str: string, len: number): string {
  return str.length > len ? str.slice(0, len) + '...' : str;
}
---
<AdminLayout title="Extractions — Admin" activePage="extractions">
  <h1 class="text-2xl font-bold mb-6">Extractions</h1>

  <!-- Filter bar -->
  <div class="bg-white rounded-lg shadow mb-6 p-4">
    <form method="get" class="flex flex-wrap gap-3 items-end">
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Scraper</label>
        <select name="scraper" class="px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All</option>
          {mappingNames.map(n => (
            <option value={n} selected={n === filterScraper}>{n}</option>
          ))}
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Grade</label>
        <select name="grade" class="px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All</option>
          {(['A', 'B', 'C', 'F'] as const).map(g => (
            <option value={g} selected={g === filterGrade}>{g}</option>
          ))}
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-500 mb-1">Search</label>
        <input
          type="text"
          name="search"
          value={filterSearch}
          placeholder="URL or title..."
          class="px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      </div>
      <button type="submit" class="px-4 py-1.5 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 transition">
        Filter
      </button>
      {(filterScraper || filterGrade || filterSearch) && (
        <a href="/admin/extractions" class="px-4 py-1.5 border border-gray-300 rounded text-sm text-gray-600 hover:bg-gray-50 no-underline">
          Clear
        </a>
      )}
    </form>
  </div>

  <!-- Summary row -->
  <div class="flex items-center justify-between text-sm text-gray-600 mb-4">
    <div>
      Showing {extractions.length} of {totalCount}
      {extractions.length > 0 && (
        <span class="ml-2">
          — A: {gradeCounts.A}, B: {gradeCounts.B}, C: {gradeCounts.C}, F: {gradeCounts.F}
        </span>
      )}
    </div>
    {extractions.length > 0 && (
      <div class="pws-bulk-export relative inline-block">
        <button
          type="button"
          class="px-3 py-1.5 bg-gray-700 text-white rounded text-xs font-medium hover:bg-gray-800 transition cursor-pointer inline-flex items-center gap-1"
          data-bulk-export-toggle
        >
          <i class="bi bi-download"></i> Export filtered results <i class="bi bi-chevron-down text-[0.55rem] ml-0.5"></i>
        </button>
        <div class="hidden absolute right-0 mt-1 w-36 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20" data-bulk-export-menu>
          <button data-bulk-format="json" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left border-0 bg-transparent cursor-pointer">
            <i class="bi bi-braces text-blue-600"></i> JSON
          </button>
          <button data-bulk-format="csv" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left border-0 bg-transparent cursor-pointer">
            <i class="bi bi-file-earmark-spreadsheet text-green-600"></i> CSV
          </button>
          <button data-bulk-format="geojson" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 w-full text-left border-0 bg-transparent cursor-pointer">
            <i class="bi bi-geo-alt text-orange-600"></i> GeoJSON
          </button>
        </div>
      </div>
    )}
  </div>

  <!-- Extractions table -->
  <div class="bg-white rounded-lg shadow">
    <div class="overflow-x-auto">
      {extractions.length === 0 ? (
        <div class="p-8 text-center text-gray-400 text-sm">No extractions found</div>
      ) : (
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500 border-b border-gray-200">
              <th class="py-2 px-4 font-medium">Time</th>
              <th class="py-2 px-4 font-medium">Source URL</th>
              <th class="py-2 px-4 font-medium">Scraper</th>
              <th class="py-2 px-4 font-medium">Quality</th>
              <th class="py-2 px-4 font-medium">Confidence</th>
              <th class="py-2 px-4 font-medium">Status</th>
              <th class="py-2 px-4 font-medium">Rate</th>
              <th class="py-2 px-4 font-medium">Fields</th>
              <th class="py-2 px-4 font-medium">Title</th>
              <th class="py-2 px-4 font-medium"></th>
            </tr>
          </thead>
          <tbody>
            {extractions.map((ext) => (
              <tr class="border-b border-gray-100 hover:bg-gray-50" data-listing-id={ext.id}>
                <td class="py-2 px-4 text-xs text-gray-500 whitespace-nowrap">{timeAgo(ext.timestamp)}</td>
                <td class="py-2 px-4 text-xs max-w-[200px] truncate" title={ext.sourceUrl}>
                  {truncate(ext.sourceUrl, 40)}
                </td>
                <td class="py-2 px-4 font-mono text-xs">{ext.scraperName}</td>
                <td class="py-2 px-4"><QualityBadge grade={ext.qualityGrade} /></td>
                <td class="py-2 px-4">
                  <div class="flex items-center gap-1.5">
                    <div class="w-12 bg-gray-100 h-1.5 rounded-full overflow-hidden">
                      <div class={`h-full ${ext.confidenceScore > 0.7 ? 'bg-green-500' : ext.confidenceScore > 0.4 ? 'bg-amber-500' : 'bg-red-500'}`} style={`width: ${ext.confidenceScore * 100}%`}></div>
                    </div>
                    <span class="text-[10px] font-bold text-gray-500">{Math.round(ext.confidenceScore * 100)}%</span>
                  </div>
                </td>
                <td class="py-2 px-4">
                  <span class={`text-[10px] font-bold uppercase px-1.5 py-0.5 rounded ${
                    ext.visibility === 'published' ? 'bg-green-100 text-green-700' :
                    ext.visibility === 'pending' ? 'bg-amber-100 text-amber-700' :
                    ext.visibility === 'spam' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'
                  }`}>
                    {ext.visibility}
                  </span>
                  {ext.manualOverride && (
                    <i class="bi bi-shield-lock text-[10px] text-blue-500 ml-1" title="Manually managed"></i>
                  )}
                </td>
                <td class="py-2 px-4 text-xs">{Math.round(ext.extractionRate * 100)}%</td>
                <td class="py-2 px-4 text-xs">{ext.populatedExtractableFields}/{ext.extractableFields}</td>
                <td class="py-2 px-4 text-xs max-w-[150px] truncate" title={ext.title}>
                  {truncate(ext.title, 30)}
                </td>
                <td class="py-2 px-4">
                  <div class="flex items-center gap-2">
                    <a href={`/admin/extractions/${ext.id}`} class="text-blue-600 hover:text-blue-800" title="View Details"><i class="bi bi-eye"></i></a>
                    <div class="relative group">
                      <button class="text-gray-400 hover:text-gray-600 border-0 bg-transparent p-0 cursor-pointer" title="Change Visibility">
                        <i class="bi bi-gear"></i>
                      </button>
                      <div class="hidden group-hover:block absolute right-0 mt-0 w-32 bg-white shadow-lg border border-gray-100 rounded-md py-1 z-30">
                        {['published', 'pending', 'hidden', 'spam'].map(v => (
                          <button 
                            class="w-full text-left px-3 py-1.5 text-[10px] font-medium hover:bg-gray-50 border-0 bg-transparent cursor-pointer disabled:opacity-50" 
                            data-action="set_visibility" 
                            data-id={ext.id} 
                            data-visibility={v}
                            disabled={ext.visibility === v}
                          >
                            Set to {v}
                          </button>
                        ))}
                      </div>
                    </div>
                    <button class="text-red-400 hover:text-red-600 border-0 bg-transparent p-0 cursor-pointer" data-action="delete" data-id={ext.id} title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  </div>

  <script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.querySelector('[data-bulk-export-toggle]');
    const menu = document.querySelector('[data-bulk-export-menu]');
    if (toggle && menu) {
      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        menu.classList.toggle('hidden');
      });
      document.addEventListener('click', () => menu.classList.add('hidden'));
    }

    document.querySelectorAll('[data-bulk-format]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const format = btn.getAttribute('data-bulk-format');
        const rows = document.querySelectorAll('tr[data-listing-id]');
        const ids = Array.from(rows).map(r => r.getAttribute('data-listing-id')).filter(Boolean);
        if (ids.length === 0) return;

        btn.textContent = 'Exporting...';
        try {
          const res = await fetch('/public_api/v1/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format, listingIds: ids }),
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Export failed');
          }
          const disposition = res.headers.get('Content-Disposition') || '';
          const match = disposition.match(/filename="(.+)"/);
          const filename = match ? match[1] : `export.${format}`;
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error('Bulk export error:', e);
        }
        menu.classList.add('hidden');
        // Restore button labels
        document.querySelectorAll('[data-bulk-format]').forEach(b => {
          const fmt = b.getAttribute('data-bulk-format');
          const icons = { json: 'bi-braces text-blue-600', csv: 'bi-file-earmark-spreadsheet text-green-600', geojson: 'bi-geo-alt text-orange-600' };
          const labels = { json: 'JSON', csv: 'CSV', geojson: 'GeoJSON' };
          b.innerHTML = '<i class="bi ' + (icons[fmt] || '') + '"></i> ' + (labels[fmt] || fmt);
        });
      });
    });
 
    // Individual Actions
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const action = btn.getAttribute('data-action');
        const listingId = btn.getAttribute('data-id');
        const visibility = btn.getAttribute('data-visibility');

        if (action === 'delete') {
          if (!confirm('Are you sure you want to delete this extraction?')) return;
        }

        btn.classList.add('opacity-50', 'pointer-events-none');

        try {
          const res = await fetch('/admin/api/listings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, listingId, visibility }),
          });
          const data = await res.json();
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.error || 'Action failed');
            btn.classList.remove('opacity-50', 'pointer-events-none');
          }
        } catch (err) {
          console.error(err);
          alert('Network error');
          btn.classList.remove('opacity-50', 'pointer-events-none');
        }
      });
    });
  });
  </script>
</AdminLayout>
