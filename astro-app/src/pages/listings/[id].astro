---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ExportDropdown from '../../components/ExportDropdown.astro';
import { initKV, getListing } from '@lib/services/listing-store.js';

initKV((Astro.locals as any).runtime?.env?.RESULTS);

const { id } = Astro.params;
const listing = id ? await getListing(id) : undefined;

let mainImageUrl = 'https://placehold.co/500x250?text=No+Image';
let osmDirectionsUrl = '';
let googleDirectionsUrl = '';

if (listing) {
  if (typeof listing.latitude === 'number' && typeof listing.longitude === 'number' && (listing.latitude !== 0 || listing.longitude !== 0)) {
    const lat = listing.latitude;
    const lng = listing.longitude;
    osmDirectionsUrl = `https://www.openstreetmap.org/directions?engine=fossgis_osrm_car&route=${lat}%2C${lng}`;
    googleDirectionsUrl = `https://www.google.com/maps/search/?api=1&query=${lat}%2C${lng}`;
  }
  if (listing.image_urls?.length > 0) {
    mainImageUrl = listing.image_urls[0].url;
  }
}

const details: [string, any][] = [];
if (listing) {
  if (listing.reference) details.push(['Reference', listing.reference]);
  if (listing.price_string) details.push(['Price', listing.price_string]);
  if (listing.count_bedrooms > 0) details.push(['Bedrooms', listing.count_bedrooms]);
  if (listing.count_bathrooms > 0) details.push(['Bathrooms', listing.count_bathrooms]);
  if (listing.constructed_area > 0) details.push(['Area', `${listing.constructed_area} ${listing.area_unit || ''}`]);
  if (listing.address_string) details.push(['Address', listing.address_string]);
}
---
<BaseLayout title={listing ? (listing.title || 'Property Details') : 'Not Found'}>

{!listing ? (
  <div class="max-w-6xl mx-auto px-4 py-12">
    <div class="flex justify-center">
      <div class="w-full max-w-lg">
        <div class="bg-amber-50 rounded-2xl p-6 text-center">
          <div class="text-3xl text-amber-600 mb-3"><i class="bi bi-exclamation-triangle"></i></div>
          <h5 class="font-semibold text-amber-900 mb-2">Listing not found</h5>
          <p class="text-amber-800 text-sm">This listing may have expired or the ID is invalid.</p>
          <div class="bg-white/60 rounded-lg p-4 mt-4 text-sm text-gray-600">
            <a href="/listings" class="text-blue-600 hover:underline"><i class="bi bi-arrow-left mr-1"></i> Browse listings</a>
          </div>
        </div>
      </div>
    </div>
  </div>
) : (
  <div class="max-w-6xl mx-auto px-4 pt-4 pb-12">
    <nav class="flex items-center gap-2 text-sm text-gray-400 mb-5">
      <a href="/" class="text-gray-500 no-underline hover:text-blue-600 transition"><i class="bi bi-house mr-1"></i>Home</a>
      <i class="bi bi-chevron-right text-[0.65rem]"></i>
      <a href="/listings" class="text-gray-500 no-underline hover:text-blue-600 transition">Listings</a>
      <i class="bi bi-chevron-right text-[0.65rem]"></i>
      <span>Property Details</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-5">
      <div>
        {listing.image_urls?.length > 1 ? (
          <div class="rounded-xl overflow-hidden relative mb-5 shadow-md">
            <div id="propertyCarousel" class="relative">
              <div class="overflow-hidden">
                <div id="carouselTrack" class="flex transition-transform duration-300 ease-in-out">
                  {listing.image_urls.map((img, i: number) => (
                    <div class="w-full flex-shrink-0">
                      <img src={img.url} class="block w-full max-h-[450px] object-cover" alt={`Property image ${i + 1}`} />
                    </div>
                  ))}
                </div>
              </div>
              <button id="carouselPrev" type="button" class="absolute left-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button id="carouselNext" type="button" class="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/40 text-white flex items-center justify-center hover:bg-black/60 transition">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            <div class="absolute bottom-3 right-3 bg-black/60 text-white px-3 py-1 rounded-full text-sm">
              <i class="bi bi-images"></i> {listing.image_urls.length} photos
            </div>
          </div>
        ) : (
          <div class="rounded-xl overflow-hidden relative mb-5 shadow-md">
            <img src={mainImageUrl} class="w-full max-h-[450px] object-cover" alt="Property image" />
          </div>
        )}

        {listing.description && (
          <div class="bg-white rounded-xl shadow-md p-6 mb-5">
            <h5 class="font-semibold text-base text-gray-800 mb-4"><i class="bi bi-text-paragraph mr-2"></i>Description</h5>
            <div class="text-sm leading-relaxed text-gray-600" set:html={listing.description}></div>
          </div>
        )}

        {osmDirectionsUrl && (
          <div class="bg-white rounded-xl shadow-md p-6 mb-5">
            <h5 class="font-semibold text-base text-gray-800 mb-4"><i class="bi bi-geo-alt mr-2"></i>Location</h5>
            <div class="rounded-lg border border-gray-200 p-4 bg-gray-50 text-sm text-gray-700">
              <p class="mb-2">Interactive map embed has been removed to avoid third-party map SDK dependency.</p>
              <div class="flex flex-wrap gap-2">
                <a
                  href={osmDirectionsUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 rounded-md border border-blue-600 px-3 py-1.5 text-blue-600 no-underline hover:bg-blue-50 transition"
                >
                  <i class="bi bi-sign-turn-right"></i>
                  Open directions (OpenStreetMap)
                </a>
                <a
                  href={googleDirectionsUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-1 rounded-md border border-gray-300 px-3 py-1.5 text-gray-700 no-underline hover:bg-gray-100 transition"
                >
                  <i class="bi bi-box-arrow-up-right"></i>
                  Open in external map app
                </a>
              </div>
            </div>
          </div>
        )}
      </div>

      <div>
        <div class="bg-white rounded-xl shadow-md p-6 sticky top-4">
          <div class="flex flex-wrap gap-2 mb-3">
            {listing.for_sale && <span class="inline-block bg-green-100 text-green-800 text-xs font-medium px-2.5 py-1 rounded-full"><i class="bi bi-house-door mr-1"></i>For Sale</span>}
            {listing.for_rent && <span class="inline-block bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full"><i class="bi bi-key mr-1"></i>For Rent</span>}
          </div>

          {listing.title && <h4 class="font-bold text-lg text-gray-900 mb-2 leading-snug">{listing.title}</h4>}

          {listing.address_string && (
            <p class="text-gray-500 text-sm mb-3"><i class="bi bi-geo-alt mr-1"></i>{listing.address_string}</p>
          )}

          {listing.price_string && (
            <div class="bg-blue-50 rounded-lg px-4 py-3.5 mb-4">
              <span class="text-2xl font-bold text-blue-600">{listing.price_string}</span>
              {listing.currency && <span class="text-sm text-gray-500 ml-1.5">{listing.currency}</span>}
            </div>
          )}

          <div class="grid grid-cols-[repeat(auto-fit,minmax(90px,1fr))] gap-3 mb-4">
            {listing.count_bedrooms > 0 && (
              <div class="text-center py-3 px-2 bg-gray-50 rounded-lg">
                <i class="bi bi-door-open block text-xl text-blue-600 mb-1"></i>
                <span class="block text-lg font-bold text-gray-900">{listing.count_bedrooms}</span>
                <span class="block text-[0.7rem] text-gray-400 uppercase tracking-wide">Bedrooms</span>
              </div>
            )}
            {listing.count_bathrooms > 0 && (
              <div class="text-center py-3 px-2 bg-gray-50 rounded-lg">
                <i class="bi bi-droplet block text-xl text-blue-600 mb-1"></i>
                <span class="block text-lg font-bold text-gray-900">{listing.count_bathrooms}</span>
                <span class="block text-[0.7rem] text-gray-400 uppercase tracking-wide">Bathrooms</span>
              </div>
            )}
            {listing.constructed_area > 0 && (
              <div class="text-center py-3 px-2 bg-gray-50 rounded-lg">
                <i class="bi bi-arrows-angle-expand block text-xl text-blue-600 mb-1"></i>
                <span class="block text-lg font-bold text-gray-900">{listing.constructed_area}</span>
                <span class="block text-[0.7rem] text-gray-400 uppercase tracking-wide">{listing.area_unit || 'm\u00B2'}</span>
              </div>
            )}
          </div>

          {details.length > 0 && (
            <div class="mb-4 border-t border-gray-200">
              {details.map(([label, value]) => (
                <div class="flex justify-between py-2 border-b border-gray-100 text-sm">
                  <span class="text-gray-400 font-medium">{label}</span>
                  <span class="text-gray-800 font-semibold text-right">{value}</span>
                </div>
              ))}
            </div>
          )}

          <div class="mb-4">
            {listing.import_url && (
              <a href={listing.import_url} target="_blank" class="block w-full text-center border border-blue-600 text-blue-600 rounded-lg py-2 text-sm hover:bg-blue-50 transition no-underline mb-2">
                <i class="bi bi-box-arrow-up-right mr-1"></i> View Original Listing
              </a>
            )}
            <div class="flex justify-center mb-2">
              <ExportDropdown listingId={id!} buttonClass="w-full text-center border border-gray-300 text-gray-600 rounded-lg py-2 text-sm hover:bg-gray-50 transition no-underline inline-flex items-center justify-center gap-1" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
)}

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  const track = document.getElementById('carouselTrack');
  const prevBtn = document.getElementById('carouselPrev');
  const nextBtn = document.getElementById('carouselNext');
  if (track && prevBtn && nextBtn) {
    const slides = track.children;
    let current = 0;
    const total = slides.length;

    function goTo(i) {
      current = ((i % total) + total) % total;
      track.style.transform = `translateX(-${current * 100}%)`;
    }

    prevBtn.addEventListener('click', () => goTo(current - 1));
    nextBtn.addEventListener('click', () => goTo(current + 1));

    let timer = setInterval(() => goTo(current + 1), 5000);
    track.parentElement.addEventListener('mouseenter', () => clearInterval(timer));
    track.parentElement.addEventListener('mouseleave', () => {
      timer = setInterval(() => goTo(current + 1), 5000);
    });
  }

});
</script>

</BaseLayout>
