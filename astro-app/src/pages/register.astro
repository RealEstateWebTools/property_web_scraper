---
import BaseLayout from '../layouts/BaseLayout.astro';
const fbApiKey = import.meta.env.PUBLIC_FIREBASE_API_KEY ?? '';
const fbAuthDomain = import.meta.env.PUBLIC_FIREBASE_AUTH_DOMAIN ?? '';
---
<BaseLayout title="Create Account — Property Web Scraper">

<div id="fb-config" data-api-key={fbApiKey} data-auth-domain={fbAuthDomain} class="hidden"></div>

<section class="max-w-lg mx-auto px-4 py-12">
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

    <div class="bg-gradient-to-br from-blue-600 to-blue-700 px-8 py-8 text-white">
      <h1 class="text-2xl font-bold mb-1">Create a free account</h1>
      <p class="text-blue-100 text-sm">Get an API key and unlock unlimited hauls.</p>
    </div>

    <!-- Registration form -->
    <div id="form-section" class="px-8 py-8">
      <div class="mb-5">
        <label for="email-input" class="block text-sm font-semibold text-gray-700 mb-2">Email address</label>
        <input
          id="email-input"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>

      <div class="mb-5">
        <label for="password-input" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
        <input
          id="password-input"
          type="password"
          placeholder="At least 6 characters"
          autocomplete="new-password"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>

      <div class="mb-6">
        <label for="confirm-input" class="block text-sm font-semibold text-gray-700 mb-2">Confirm password</label>
        <input
          id="confirm-input"
          type="password"
          placeholder="Repeat password"
          autocomplete="new-password"
          class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
        />
      </div>

      <p id="form-error" class="text-red-600 text-xs mb-4 hidden"></p>

      <button id="register-btn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors cursor-pointer border-0">
        Create Account
      </button>

      <p class="text-xs text-gray-400 mt-4 text-center">
        Already have an account?
        <a href="/login" class="text-blue-600 hover:underline">Sign in</a>
      </p>
    </div>

    <!-- Success: check inbox -->
    <div id="success-section" class="hidden px-8 py-8">
      <div class="flex items-center gap-2 text-green-700 mb-4">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        <span class="font-semibold text-base">Account created!</span>
      </div>
      <p class="text-sm text-gray-600 mb-4">
        We've sent a verification email to <strong id="sent-to"></strong>.
        Click the link in the email to verify your address, then you can get your API key.
      </p>
      <a href="/verify-email"
        class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl text-sm transition-colors no-underline">
        I've verified — continue
      </a>
    </div>

  </div>
</section>

<script is:inline>
(function () {
  var cfg = document.getElementById('fb-config');
  var apiKey = cfg && cfg.dataset.apiKey;
  var authDomain = cfg && cfg.dataset.authDomain;

  var emailInput = document.getElementById('email-input');
  var passwordInput = document.getElementById('password-input');
  var confirmInput = document.getElementById('confirm-input');
  var formError = document.getElementById('form-error');
  var registerBtn = document.getElementById('register-btn');
  var formSection = document.getElementById('form-section');
  var successSection = document.getElementById('success-section');
  var sentTo = document.getElementById('sent-to');

  function showError(msg) {
    formError.textContent = msg;
    formError.classList.remove('hidden');
  }

  function hideError() {
    formError.classList.add('hidden');
  }

  registerBtn.addEventListener('click', async function () {
    hideError();

    var email = emailInput.value.trim();
    var password = passwordInput.value;
    var confirm = confirmInput.value;

    if (!email || !email.includes('@')) {
      showError('Please enter a valid email address.');
      return;
    }
    if (password.length < 6) {
      showError('Password must be at least 6 characters.');
      return;
    }
    if (password !== confirm) {
      showError('Passwords do not match.');
      return;
    }

    registerBtn.disabled = true;
    registerBtn.textContent = 'Creating account…';

    try {
      var baseUrl = 'https://www.gstatic.com/firebasejs/11.3.1/';
      var app = await import(baseUrl + 'firebase-app.js');
      var auth = await import(baseUrl + 'firebase-auth.js');

      var firebaseApp = app.initializeApp({ apiKey: apiKey, authDomain: authDomain });
      var firebaseAuth = auth.getAuth(firebaseApp);

      var cred = await auth.createUserWithEmailAndPassword(firebaseAuth, email, password);
      await auth.sendEmailVerification(cred.user, {
        url: window.location.origin + '/account',
      });

      sentTo.textContent = email;
      formSection.classList.add('hidden');
      successSection.classList.remove('hidden');
    } catch (err) {
      registerBtn.disabled = false;
      registerBtn.textContent = 'Create Account';
      var msg = err.message || 'Something went wrong. Please try again.';
      if (err.code === 'auth/email-already-in-use') {
        msg = 'An account with this email already exists. <a href="/login" class="underline">Sign in instead</a>.';
        formError.innerHTML = msg;
        formError.classList.remove('hidden');
        return;
      }
      showError(msg);
    }
  });
})();
</script>

</BaseLayout>
