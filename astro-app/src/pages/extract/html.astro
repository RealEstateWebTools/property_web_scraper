---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { retrieveListing } from '@lib/services/listing-retriever.js';
import { generateStableId, storeListing, storeDiagnostics } from '@lib/services/listing-store.js';
import { recordScrapeAndUpdatePortal } from '@lib/services/scrape-metadata.js';
import { screenUrl } from '@lib/services/url-screener.js';
import { addToHaulAndRedirect } from '@lib/pages-helpers/astro-redirect-with-haul.js';

const prefillUrl = Astro.url.searchParams.get('url') || '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const importUrl = (formData.get('import_url') as string || '').trim();
  const html = (formData.get('html') as string || '').trim();

  if (!importUrl) {
    return Astro.redirect('/extract/error?reason=missing_url');
  }

  // Screen the URL before extraction
  const screening = screenUrl(importUrl);
  if (screening.verdict === 'not_real_estate') {
    return Astro.redirect(`/extract/error?reason=not_real_estate&url=${encodeURIComponent(importUrl)}`);
  }
  if (screening.verdict === 'search_results') {
    return Astro.redirect(`/extract/error?reason=search_results&url=${encodeURIComponent(importUrl)}`);
  }

  if (!html) {
    return Astro.redirect(`/extract/error?reason=error&url=${encodeURIComponent(importUrl)}&message=${encodeURIComponent('Please provide the page HTML')}`);
  }

  const result = await retrieveListing(importUrl, html);

  if (!result.success || !result.retrievedListing) {
    const reason = result.errorMessage === 'Unsupported Url' ? 'unsupported' : 'error';
    return Astro.redirect(`/extract/error?reason=${reason}&url=${encodeURIComponent(importUrl)}&message=${encodeURIComponent(result.errorMessage || 'Unknown error')}`);
  }

  const id = generateStableId(importUrl);
  await storeListing(id, result.retrievedListing);
  if (result.diagnostics) {
    await storeDiagnostics(id, result.diagnostics);
  }
  // Persist to Firestore for admin queries
  result.retrievedListing.id = id;
  try { await result.retrievedListing.save(); } catch { /* Firestore unavailable */ }

  await recordScrapeAndUpdatePortal({
    listingId: id,
    sourceUrl: importUrl,
    html,
    sourceType: 'manual_html',
    scraperName: result.diagnostics?.scraperName,
    portalSlug: result.diagnostics?.scraperName,
    requestContentType: Astro.request.headers.get('content-type') || undefined,
    clientUserAgent: Astro.request.headers.get('user-agent'),
    diagnostics: result.diagnostics,
  });

  return addToHaulAndRedirect(Astro.request, id, result.retrievedListing, result.diagnostics);
}
---
<BaseLayout title="Extract from HTML - Property Web Scraper">

<section class="max-w-6xl mx-auto px-4 py-12">
  <div class="flex justify-center">
    <div class="w-full max-w-2xl">

      <!-- Mode switcher -->
      <div class="flex gap-1 p-1 bg-gray-100 rounded-lg mb-6">
        <a href="/extract/url" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline text-gray-500 hover:text-gray-700 hover:bg-white/60 transition">
          <i class="bi bi-link-45deg"></i> Enter URL
        </a>
        <a href="/extract/html" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline bg-white text-blue-600 shadow-sm">
          <i class="bi bi-code-slash"></i> Paste HTML
        </a>
        <a href="/extract/upload" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline text-gray-500 hover:text-gray-700 hover:bg-white/60 transition">
          <i class="bi bi-file-earmark-arrow-up"></i> Upload File
        </a>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-8">
        <h4 class="mb-2 font-semibold text-lg">Extract from Pasted HTML</h4>
        <p class="text-xs text-gray-400 mb-5">
          Paste the fully-rendered HTML from your browser for JavaScript-heavy sites.
        </p>

        <form method="post" action="/extract/html" enctype="multipart/form-data">
          <div class="mb-4">
            <label for="import_url" class="block text-sm font-semibold mb-1">Property URL</label>
            <input type="text" name="import_url" id="import_url"
                   class="w-full px-4 py-2.5 border-[1.5px] border-gray-300 rounded-lg text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition"
                   placeholder="https://www.idealista.com/inmueble/12345678/"
                   value={prefillUrl} required />
          </div>

          <div class="mb-4">
            <label for="html_input" class="block text-sm font-semibold mb-1">Page HTML</label>
            <textarea name="html" id="html_input"
                      class="w-full px-4 py-2.5 border-[1.5px] border-gray-300 rounded-lg text-sm font-mono min-h-[120px] resize-y focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition"
                      rows="8" placeholder="Paste the full page source here..." required></textarea>
            <p class="text-xs text-gray-400 mt-1">
              <i class="bi bi-lightbulb"></i> Right-click the page in your browser, select "View Page Source", and copy all the HTML.
              <a href="/docs/get-html" class="text-blue-500 hover:underline">Need help getting the HTML?</a>
            </p>
          </div>

          <button type="submit"
                  class="w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 transition active:scale-[0.98]">
            Extract from HTML
          </button>
        </form>
      </div>

      <p class="mt-3 text-xs text-gray-400 text-center">
        Extracted data is provided as-is. Verify details directly with the source site.
        By using this service you agree to our <a href="/terms" class="underline hover:text-gray-600">Terms of Service</a>.
      </p>

      <div class="mt-3 text-center text-xs text-gray-400">
        <i class="bi bi-puzzle mr-1"></i> Want to skip the copy-paste? The <a href="/extension" class="text-blue-500 hover:underline">Chrome Extension</a> captures and extracts in one click.
      </div>

    </div>
  </div>
</section>

</BaseLayout>
