---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { retrieveListing } from '@lib/services/listing-retriever.js';
import { initKV, generateId, storeListing, storeDiagnostics } from '@lib/services/listing-store.js';
import { initScrapeMetadataKV, recordScrapeAndUpdatePortal } from '@lib/services/scrape-metadata.js';
import { screenUrl } from '@lib/services/url-screener.js';

initKV((Astro.locals as any).runtime?.env?.RESULTS);
initScrapeMetadataKV((Astro.locals as any).runtime?.env?.RESULTS);

const prefillUrl = Astro.url.searchParams.get('url') || '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const importUrl = (formData.get('import_url') as string || '').trim();
  const htmlFile = formData.get('html_file');

  if (!importUrl) {
    return Astro.redirect('/extract/error?reason=missing_url');
  }

  // Screen the URL before extraction
  const screening = screenUrl(importUrl);
  if (screening.verdict === 'not_real_estate') {
    return Astro.redirect(`/extract/error?reason=not_real_estate&url=${encodeURIComponent(importUrl)}`);
  }
  if (screening.verdict === 'search_results') {
    return Astro.redirect(`/extract/error?reason=search_results&url=${encodeURIComponent(importUrl)}`);
  }

  let html = '';
  if (htmlFile && htmlFile instanceof File && htmlFile.size > 0) {
    html = await htmlFile.text();
  }

  if (!html) {
    return Astro.redirect(`/extract/error?reason=error&url=${encodeURIComponent(importUrl)}&message=${encodeURIComponent('Please upload an HTML file')}`);
  }

  const result = await retrieveListing(importUrl, html);

  if (!result.success || !result.retrievedListing) {
    const reason = result.errorMessage === 'Unsupported Url' ? 'unsupported' : 'error';
    return Astro.redirect(`/extract/error?reason=${reason}&url=${encodeURIComponent(importUrl)}&message=${encodeURIComponent(result.errorMessage || 'Unknown error')}`);
  }

  const id = generateId();
  await storeListing(id, result.retrievedListing);
  if (result.diagnostics) {
    await storeDiagnostics(id, result.diagnostics);
  }

  await recordScrapeAndUpdatePortal({
    listingId: id,
    sourceUrl: importUrl,
    html,
    sourceType: 'html_upload',
    scraperName: result.diagnostics?.scraperName,
    portalSlug: result.diagnostics?.scraperName,
    requestContentType: Astro.request.headers.get('content-type') || undefined,
    clientUserAgent: Astro.request.headers.get('user-agent'),
    diagnostics: result.diagnostics,
  });

  return Astro.redirect(`/extract/results/${id}`);
}
---
<BaseLayout title="Extract from File - Property Web Scraper">

<section class="max-w-6xl mx-auto px-4 py-12">
  <div class="flex justify-center">
    <div class="w-full max-w-2xl">

      <!-- Mode switcher -->
      <div class="flex gap-1 p-1 bg-gray-100 rounded-lg mb-6">
        <a href="/extract/url" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline text-gray-500 hover:text-gray-700 hover:bg-white/60 transition">
          <i class="bi bi-link-45deg"></i> Enter URL
        </a>
        <a href="/extract/html" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline text-gray-500 hover:text-gray-700 hover:bg-white/60 transition">
          <i class="bi bi-code-slash"></i> Paste HTML
        </a>
        <a href="/extract/upload" class="flex-1 text-center py-2 px-3 rounded-md text-sm font-medium no-underline bg-white text-blue-600 shadow-sm">
          <i class="bi bi-file-earmark-arrow-up"></i> Upload File
        </a>
      </div>

      <div class="bg-white rounded-2xl shadow-lg p-8">
        <h4 class="mb-2 font-semibold text-lg">Extract from HTML File</h4>
        <p class="text-xs text-gray-400 mb-5">
          Upload a saved HTML file from your computer.
        </p>

        <form method="post" action="/extract/upload" enctype="multipart/form-data">
          <div class="mb-4">
            <label for="import_url" class="block text-sm font-semibold mb-1">Property URL</label>
            <input type="text" name="import_url" id="import_url"
                   class="w-full px-4 py-2.5 border-[1.5px] border-gray-300 rounded-lg text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition"
                   placeholder="https://www.idealista.com/inmueble/12345678/"
                   value={prefillUrl} required />
            <p class="text-xs text-gray-400 mt-1">
              The URL of the page you saved, so we know which scraper mapping to use.
              <a href="/docs/get-html" class="text-blue-500 hover:underline">Need help saving the page as HTML?</a>
            </p>
          </div>

          <div class="mb-4">
            <label for="html_file_input" class="block text-sm font-semibold mb-1">HTML File</label>
            <input type="file" name="html_file" id="html_file_input"
                   class="w-full px-4 py-2.5 border-[1.5px] border-gray-300 rounded-lg text-sm file:mr-4 file:py-1 file:px-3 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-600 hover:file:bg-blue-100"
                   accept=".html,.htm" required />
          </div>

          <button type="submit"
                  class="w-full bg-blue-600 text-white font-semibold py-2.5 rounded-lg hover:bg-blue-700 transition active:scale-[0.98]">
            Upload &amp; Extract
          </button>
        </form>
      </div>

    </div>
  </div>
</section>

</BaseLayout>
