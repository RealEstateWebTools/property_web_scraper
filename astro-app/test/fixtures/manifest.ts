/**
 * Scraper Validation Manifest
 *
 * Workflow for fixing broken scrapers:
 *
 * 1. **Identify failures**: Run `npx vitest run test/lib/scraper-validation.test.ts`
 * 2. **Inspect HTML**: Open `test/fixtures/SCRAPER.html`, find the actual DOM elements
 * 3. **Fix mapping**: Edit `config/scraper_mappings/SCRAPER.json` with correct selectors
 * 4. **Update manifest**: Update expected values in `test/fixtures/manifest.ts`
 * 5. **Verify**: Re-run tests
 *
 * Common pitfalls:
 * - Field in multiple sections → last wins (textFields overwrites intFields)
 * - No `cssCountId` → Cheerio concatenates ALL matched elements
 * - Cheerio converts `<br>` → `\n` not `\r`
 * - `defaultValues` always produces strings (e.g. `for_sale: "true"`)
 * - Processing order: defaults → images → features → int → float → text → boolean
 */
export interface FixtureEntry {
  scraper: string;
  fixture: string | null;
  sourceUrl: string;
  expected: Record<string, unknown>;
}

export const fixtures: FixtureEntry[] = [
  {
    scraper: 'idealista',
    fixture: 'idealista_2018_01',
    sourceUrl: 'https://www.idealista.com/pro/rv-gestion-inmobiliaria/inmueble/38604738/',
    expected: {
      title: 'Piso en venta en goya, 54, Goya, Madrid',
      price_string: '990.000',
      price_float: 990000.0,
      currency: 'EUR',
      constructed_area: 172,
      reference: '38604738',
      for_sale: true,
      for_rent: false,
      latitude: 40.4246556,
      longitude: -3.678188,
    },
  },
  {
    scraper: 'rightmove',
    fixture: 'rightmove',
    sourceUrl: 'http://www.rightmove.co.uk/property-to-rent/property-51775029.html',
    expected: {
      for_rent: true,
      for_sale: false,
      longitude: -1.8683744229091472,
      latitude: 52.413249369181294,
      postal_code: 'B14 4JP',
      reference: '51775029',
      title: '4 bedroom detached house to rent in School Road, Birmingham, B14, B14',
      address_string: 'School Road, Birmingham, B14',
      currency: 'GBP',
      price_string: '\u00A3995 pcm',
      price_float: 995.0,
      count_bedrooms: 4,
    },
  },
  {
    scraper: 'realtor',
    fixture: 'realtor',
    sourceUrl: 'http://www.realtor.com/realestateandhomes-detail/5804-Cedar-Glen-Ln_Bakersfield_CA_93313_M12147-18296',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: '5804 Cedar Glen Ln',
      price_string: '$144,950',
      price_float: 144950,
      constructed_area: 1133,
      count_bedrooms: 3,
      count_bathrooms: 2,
      latitude: 35.302092,
      longitude: -119.051509,
      reference: '602458820',
      postal_code: '93313',
      city: 'Bakersfield',
      region: 'CA',
      address_string: '5804 Cedar Glen Ln',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'fotocasa',
    fixture: 'fotocasa',
    sourceUrl: 'https://www.fotocasa.es/vivienda/madrid/piso-123',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Casa adosada en Marbella Centro / El Higueral - La Merced, Marbella',
      count_bedrooms: 3,
      count_bathrooms: 3,
      price_string: '1.330.000 \u20AC',
      price_float: 1330000,
      reference: '145228694',
      latitude: 0,
      longitude: 0,
      for_rent: false,
      for_sale: false,
    },
  },
  {
    scraper: 'zoopla',
    fixture: 'zoopla',
    sourceUrl: 'https://www.zoopla.co.uk/to-rent/details/12345678',
    expected: {
      country: 'UK',
      currency: 'GBP',
      title: '4 bed flat for sale',
      address_string: '38 St. Pauls Square, Birmingham B3',
      constructed_area: 2205,
      price_float: 875000,
      price_string: '\u00A3875,000',
      count_bedrooms: 4,
    },
  },
  {
    scraper: 'pisos',
    fixture: 'pisos_dot_com',
    sourceUrl: 'https://www.pisos.com/comprar/piso-madrid_capital/12345/',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Piso en venta en Calle Goya, n\u00BA 54 en Goya por 990.000 \u20AC',
      price_string: '990.000 \u20AC',
    },
  },
  {
    scraper: 'realestateindia',
    fixture: 'realestateindia',
    sourceUrl: 'https://www.realestateindia.com/property-detail/residential-property-for-sale-in-delhi-12345.htm',
    expected: {
      country: 'India',
      currency: 'INR',
      title: '2 BHK Flats & Apartments for Rent in Andheri West, Mumbai - 10000 Sq. Yards',
      price_float: 45000,
      price_string: '45,000',
      latitude: 0,
      longitude: 0,
      for_rent: true,
      for_rent_long_term: true,
      for_sale: false,
    },
  },
  {
    scraper: 'mlslistings',
    fixture: 'mlslistings',
    sourceUrl: 'https://www.mlslistings.com/property/ml81234567/some-address',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: '1547 Desdemona CT, SAN JOSE, CA 95121 ( For Sale )',
      price_string: '$489,000',
      price_float: 489000,
      constructed_area: 1176,
      latitude: 37.313407,
      longitude: -121.823499,
      reference: 'ML81643266',
      count_bedrooms: '3',
      for_sale: true,
    },
  },
  {
    scraper: 'pwb',
    fixture: 'pwb',
    sourceUrl: 'https://www.propertyweb.co.za/property/12345/some-property',
    expected: {
      title: 'Chalet in Cala Blava / Llucmajor',
      reference: 'Gu_001',
      property_type: 'Chalet',
      latitude: 39.4828874,
      longitude: 2.73674249999999,
      postal_code: '07609',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'inmo1',
    fixture: 'inmo1',
    sourceUrl: 'https://www.inmo1.com/propiedad/12345',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Acogedor piso en Anton Martin',
      reference: 'BUHARDILLA CALLE ATOCHA ANTON MARTIN',
      property_type: 'Apartment',
      city: 'Madrid',
      region: 'Atocha',
      postal_code: '28012',
      count_bedrooms: 2,
      count_bathrooms: 2,
      constructed_area: 75,
      price_float: 1700,
      latitude: 40.411213,
      longitude: -3.70364310000002,
      for_sale: false,
      for_rent: true,
      for_rent_long_term: true,
    },
  },
  {
    scraper: 'wyomingmls',
    fixture: 'wyomingmls',
    sourceUrl: 'https://www.wyomingmls.com/listing/12345',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: 'Residential Property 20176813 - Wyoming MLS - Your Complete Source For Real Estate in Wyoming',
      year_construction: 2002,
      count_bedrooms: 3,
      count_bathrooms: 2,
      constructed_area: 1056,
      latitude: 42.852044,
      longitude: -106.28227,
      price_float: 33500,
      price_string: '$33,500',
      reference: '20176813',
    },
  },
  {
    scraper: 'idealista_2017',
    fixture: 'idealista_2017',
    sourceUrl: 'https://www.idealista.com/inmueble/12345/',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'D\u00FAplex en venta en calle Subida Amargura, 2, El Molar',
      price_string: '82.000',
      price_float: 82000,
      constructed_area: 70,
      count_bedrooms: 2,
      reference: '1678322',
      latitude: 40.732845,
      longitude: -3.5815072,
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'cerdfw',
    fixture: null,
    sourceUrl: 'https://www.cerdfw.com/listing/12345',
    expected: {},
  },
  {
    scraper: 'carusoimmobiliare',
    fixture: null,
    sourceUrl: 'https://www.carusoimmobiliare.com/immobile/12345',
    expected: {},
  },
  {
    scraper: 'forsalebyowner',
    fixture: null,
    sourceUrl: 'https://www.forsalebyowner.com/listing/12345',
    expected: {},
  },
  {
    scraper: 'weebrix',
    fixture: null,
    sourceUrl: 'https://www.weebrix.com/property/12345',
    expected: {},
  },
  {
    scraper: 'uk_jitty',
    fixture: 'uk_jitty',
    sourceUrl: 'https://jitty.com/properties/kuHhs7dJrhbfbs6ObUK9',
    expected: {
      address_string: 'Bests Penquite, Blisland',
      area_unit: 'sqft',
      constructed_area: 3031,
      count_bathrooms: 2,
      count_bedrooms: 3,
      country: 'UK',
      currency: 'GBP',
      description: '3 Bed Detached House For Sale In Bests Penquite, Blisland. Cut through irrelevant listings with powerful filters and AI search.',
      for_rent: false,
      for_rent_long_term: false,
      for_rent_short_term: 'false',
      for_sale: true,
      latitude: 50.546295,
      locale_code: 'en',
      longitude: -4.676616,
      main_image_url: 'https://jitty-cdn.com/cdn-cgi/image/w=1200,h=630,fit=cover/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCQTVPWmcwPSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--1cbdef013c63326138339c360f39c9d18c6be9d5',
      price_float: 895000,
      price_string: '\u00a3895,000',
      property_type: 'Detached',
      reference: 'kuHhs7dJrhbfbs6ObUK9',
      title: 'Bests Penquite, Blisland',
    },
  },
];
