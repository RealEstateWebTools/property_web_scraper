/**
 * Scraper Validation Manifest
 *
 * Workflow for fixing broken scrapers:
 *
 * 1. **Identify failures**: Run `npx vitest run test/lib/scraper-validation.test.ts`
 * 2. **Inspect HTML**: Open `test/fixtures/SCRAPER.html`, find the actual DOM elements
 * 3. **Fix mapping**: Edit `config/scraper_mappings/SCRAPER.json` with correct selectors
 * 4. **Update manifest**: Update expected values in `test/fixtures/manifest.ts`
 * 5. **Verify**: Re-run tests
 *
 * Common pitfalls:
 * - Field in multiple sections → last wins (textFields overwrites intFields)
 * - No `cssCountId` → Cheerio concatenates ALL matched elements
 * - Cheerio converts `<br>` → `\n` not `\r`
 * - `defaultValues` always produces strings (e.g. `for_sale: "true"`)
 * - Processing order: defaults → images → features → int → float → text → boolean
 */
export interface FixtureEntry {
  scraper: string;
  fixture: string | null;
  sourceUrl: string;
  expected: Record<string, unknown>;
}

export const fixtures: FixtureEntry[] = [
  {
    scraper: 'idealista',
    fixture: 'idealista_2018_01',
    sourceUrl: 'https://www.idealista.com/pro/rv-gestion-inmobiliaria/inmueble/38604738/',
    expected: {
      title: 'Piso en venta en goya, 54, Goya, Madrid',
      price_string: '990.000',
      price_float: 990000.0,
      currency: 'EUR',
      constructed_area: 172,
      reference: '38604738',
      for_sale: true,
      for_rent: false,
      latitude: 40.4246556,
      longitude: -3.678188,
    },
  },
  {
    scraper: 'rightmove',
    fixture: 'rightmove',
    sourceUrl: 'http://www.rightmove.co.uk/property-to-rent/property-51775029.html',
    expected: {
      for_rent: true,
      for_sale: false,
      longitude: -1.8683744229091472,
      latitude: 52.413249369181294,
      postal_code: 'B14 4JP',
      reference: '51775029',
      title: '4 bedroom detached house to rent in School Road, Birmingham, B14, B14',
      address_string: 'School Road, Birmingham, B14',
      currency: 'GBP',
      price_string: '\u00A3995 pcm',
      price_float: 995.0,
      count_bedrooms: 4,
    },
  },
  {
    scraper: 'realtor',
    fixture: 'realtor',
    sourceUrl: 'http://www.realtor.com/realestateandhomes-detail/5804-Cedar-Glen-Ln_Bakersfield_CA_93313_M12147-18296',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: '5804 Cedar Glen Ln',
      price_string: '$144,950',
      price_float: 144950,
      constructed_area: 1133,
      count_bedrooms: 3,
      count_bathrooms: 2,
      latitude: 35.302092,
      longitude: -119.051509,
      reference: '602458820',
      postal_code: '93313',
      city: 'Bakersfield',
      region: 'CA',
      address_string: '5804 Cedar Glen Ln',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'fotocasa',
    fixture: 'fotocasa',
    sourceUrl: 'https://www.fotocasa.es/vivienda/madrid/piso-123',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Casa adosada en Marbella Centro / El Higueral - La Merced, Marbella',
      count_bedrooms: 3,
      count_bathrooms: 3,
      price_string: '1.330.000 \u20AC',
      price_float: 1330000,
      reference: '145228694',
      latitude: 0,
      longitude: 0,
      for_rent: false,
      for_sale: false,
    },
  },
  {
    scraper: 'zoopla',
    fixture: 'zoopla',
    sourceUrl: 'https://www.zoopla.co.uk/to-rent/details/12345678',
    expected: {
      country: 'UK',
      currency: 'GBP',
      title: '4 bed flat for sale',
      address_string: '38 St. Pauls Square, Birmingham B3',
      constructed_area: 2205,
      price_float: 875000,
      price_string: '\u00A3875,000',
      count_bedrooms: 4,
    },
  },
  {
    scraper: 'pisos',
    fixture: 'pisos_dot_com',
    sourceUrl: 'https://www.pisos.com/comprar/piso-madrid_capital/12345/',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Piso en venta en Calle Goya, n\u00BA 54 en Goya por 990.000 \u20AC',
      price_string: '990.000 \u20AC',
    },
  },
  {
    scraper: 'realestateindia',
    fixture: 'realestateindia',
    sourceUrl: 'https://www.realestateindia.com/property-detail/residential-property-for-sale-in-delhi-12345.htm',
    expected: {
      country: 'India',
      currency: 'INR',
      title: '2 BHK Flats & Apartments for Rent in Andheri West, Mumbai - 10000 Sq. Yards',
      price_float: 45000,
      price_string: '45,000',
      latitude: 0,
      longitude: 0,
      for_rent: true,
      for_rent_long_term: true,
      for_sale: false,
    },
  },
  {
    scraper: 'mlslistings',
    fixture: 'mlslistings',
    sourceUrl: 'https://www.mlslistings.com/property/ml81234567/some-address',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: '1547 Desdemona CT, SAN JOSE, CA 95121 ( For Sale )',
      price_string: '$489,000',
      price_float: 489000,
      constructed_area: 1176,
      latitude: 37.313407,
      longitude: -121.823499,
      reference: 'ML81643266',
      count_bedrooms: '3',
      for_sale: true,
    },
  },
  {
    scraper: 'pwb',
    fixture: 'pwb',
    sourceUrl: 'https://www.propertyweb.co.za/property/12345/some-property',
    expected: {
      title: 'Chalet in Cala Blava / Llucmajor',
      reference: 'Gu_001',
      property_type: 'Chalet',
      latitude: 39.4828874,
      longitude: 2.73674249999999,
      postal_code: '07609',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'inmo1',
    fixture: 'inmo1',
    sourceUrl: 'https://www.inmo1.com/propiedad/12345',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Acogedor piso en Anton Martin',
      reference: 'BUHARDILLA CALLE ATOCHA ANTON MARTIN',
      property_type: 'Apartment',
      city: 'Madrid',
      region: 'Atocha',
      postal_code: '28012',
      count_bedrooms: 2,
      count_bathrooms: 2,
      constructed_area: 75,
      price_float: 1700,
      latitude: 40.411213,
      longitude: -3.70364310000002,
      for_sale: false,
      for_rent: true,
      for_rent_long_term: true,
    },
  },
  {
    scraper: 'wyomingmls',
    fixture: 'wyomingmls',
    sourceUrl: 'https://www.wyomingmls.com/listing/12345',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: 'Residential Property 20176813 - Wyoming MLS - Your Complete Source For Real Estate in Wyoming',
      year_construction: 2002,
      count_bedrooms: 3,
      count_bathrooms: 2,
      constructed_area: 1056,
      latitude: 42.852044,
      longitude: -106.28227,
      price_float: 33500,
      price_string: '$33,500',
      reference: '20176813',
    },
  },
  {
    scraper: 'idealista_2017',
    fixture: 'idealista_2017',
    sourceUrl: 'https://www.idealista.com/inmueble/12345/',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'D\u00FAplex en venta en calle Subida Amargura, 2, El Molar',
      price_string: '82.000',
      price_float: 82000,
      constructed_area: 70,
      count_bedrooms: 2,
      reference: '1678322',
      latitude: 40.732845,
      longitude: -3.5815072,
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'cerdfw',
    fixture: 'cerdfw',
    sourceUrl: 'https://www.cerdfw.com/listing/12345',
    expected: {
      country: 'USA',
      currency: 'USD',
      title: '123 Oak Street, Fort Worth, TX 76102',
      price_string: '$285,000',
      reference: 'MLS-20240567',
      city: 'Fort Worth',
      address_string: '123 Oak Street',
      latitude: 32.7555,
      longitude: -97.3308,
    },
  },
  {
    scraper: 'carusoimmobiliare',
    fixture: 'carusoimmobiliare',
    sourceUrl: 'https://www.carusoimmobiliare.com/immobile/12345',
    expected: {
      country: 'IT',
      currency: 'EUR',
      title: 'Appartamento in vendita a Trapani - Caruso Immobiliare',
      city: 'Trapani',
      latitude: 38.0174,
      longitude: 12.5365,
    },
  },
  {
    scraper: 'forsalebyowner',
    fixture: 'forsalebyowner',
    sourceUrl: 'https://www.forsalebyowner.com/listing/12345',
    expected: {
      country: 'USA',
      currency: 'USD',
      price_string: '$349,900',
      description: 'Charming 4 bedroom home with modern updates throughout. Open floor plan with hardwood floors.',
    },
  },
  {
    scraper: 'weebrix',
    fixture: 'weebrix',
    sourceUrl: 'https://www.weebrix.com/property/12345',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      reference: 'WBX-MAR-2024',
      property_type: 'Villa',
      city: 'Marbella',
      region: 'Costa del Sol',
      postal_code: '29602',
      latitude: 36.5099,
      longitude: -4.8861,
    },
  },
  {
    scraper: 'rightmove_v2',
    fixture: 'rightmove_v2',
    sourceUrl: 'https://www.rightmove.co.uk/properties/168908774',
    expected: {
      country: 'UK',
      currency: 'GBP',
      title: '2 bedroom apartment for sale in Augustine Way, Oxford, OX4',
      address_string: 'Augustine Way, Oxford',
      price_string: '\u00A3105,000',
      price_float: 105000,
      count_bedrooms: 2,
      count_bathrooms: 1,
      latitude: 51.73383,
      longitude: -1.23336,
      reference: '168908774',
      postal_code: 'OX4 4DG',
      property_type: 'Apartment',
      tenure: 'LEASEHOLD',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'uk_jitty',
    fixture: 'uk_jitty',
    sourceUrl: 'https://jitty.com/properties/kuHhs7dJrhbfbs6ObUK9',
    expected: {
      address_string: 'Bests Penquite, Blisland',
      area_unit: 'sqft',
      constructed_area: 3031,
      count_bathrooms: 2,
      count_bedrooms: 3,
      country: 'UK',
      currency: 'GBP',
      description: '3 Bed Detached House For Sale In Bests Penquite, Blisland. Cut through irrelevant listings with powerful filters and AI search.',
      for_rent: false,
      for_rent_long_term: false,
      for_rent_short_term: 'false',
      for_sale: true,
      latitude: 50.546295,
      locale_code: 'en',
      longitude: -4.676616,
      main_image_url: 'https://jitty-cdn.com/cdn-cgi/image/w=1200,h=630,fit=cover/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCQTVPWmcwPSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--1cbdef013c63326138339c360f39c9d18c6be9d5',
      price_float: 895000,
      price_string: '\u00a3895,000',
      property_type: 'Detached',
      reference: 'kuHhs7dJrhbfbs6ObUK9',
      title: 'Bests Penquite, Blisland',
    },
  },
  {
    scraper: 'zoopla_v2',
    fixture: 'zoopla_v2',
    sourceUrl: 'https://www.zoopla.co.uk/for-sale/details/71695439/',
    expected: {
      country: 'UK',
      currency: 'GBP',
      title: 'Manor Lane, Bredons Norton, Gloucestershire GL20, 2 bed barn conversion for sale, \u00A3625,000 - Zoopla',
      address_string: 'Manor Lane, Bredons Norton, Gloucestershire GL20',
      description: 'A charming 2 bedroom barn conversion, tucked away in a quiet courtyard within this peaceful sought after village.',
      price_float: 625000,
      count_bedrooms: 2,
      count_bathrooms: 2,
      latitude: 52.044659,
      longitude: -2.103232,
      reference: '71695439',
      postal_code: 'GL20 7HB',
      property_type: 'barn_conversion',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'onthemarket',
    fixture: 'onthemarket',
    sourceUrl: 'https://www.onthemarket.com/details/15269498/',
    expected: {
      country: 'UK',
      currency: 'GBP',
      title: 'Elm Grove, Brighton, BN2 3ES 3 bed semi-detached house for sale - \u00A3425,000 - OnTheMarket',
      address_string: 'Elm Grove, Brighton, BN2 3ES',
      description: 'A beautifully presented 3 bedroom semi-detached house in the heart of Brighton.',
      price_string: '\u00A3425,000',
      price_float: 425000,
      count_bedrooms: 3,
      count_bathrooms: 2,
      latitude: 50.8295,
      longitude: -0.1227,
      reference: '15269498',
      property_type: 'Semi-detached house',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'daft',
    fixture: 'daft',
    sourceUrl: 'https://www.daft.ie/for-sale/semi-detached-house-42-griffith-avenue-dublin-9/4567890',
    expected: {
      country: 'Ireland',
      currency: 'EUR',
      title: '42 Griffith Avenue, Dublin 9, D09 Y6X0 is for sale on Daft.ie',
      address_string: '42 Griffith Avenue, Dublin 9, D09 Y6X0',
      description: 'Spacious 3 bedroom semi-detached family home in excellent condition.',
      price_string: '\u20AC495,000',
      price_float: 495000,
      count_bedrooms: 3,
      count_bathrooms: 2,
      constructed_area: 120,
      latitude: 53.3741,
      longitude: -6.2488,
      reference: '4567890',
      property_type: 'Semi-Detached House',
      city: 'Dublin 9',
      region: 'Dublin',
      for_sale: true,
      for_rent: false,
    },
  },
  {
    scraper: 'idealista_v2',
    fixture: 'idealista_v2',
    sourceUrl: 'https://www.idealista.com/inmueble/98765432/',
    expected: {
      country: 'Spain',
      currency: 'EUR',
      title: 'Piso en venta en calle de Serrano, 50, Salamanca, Madrid',
      address_string: 'calle de Serrano, 50',
      description: 'Magn\u00EDfico piso en una de las mejores calles de Madrid.',
      price_float: 1250000,
      count_bedrooms: 4,
      count_bathrooms: 3,
      constructed_area: 185,
      latitude: 40.4308,
      longitude: -3.6868,
      reference: '98765432',
      postal_code: '28006',
      city: 'Madrid',
      region: 'Salamanca',
      for_sale: true,
      for_rent: false,
    },
  },
];
